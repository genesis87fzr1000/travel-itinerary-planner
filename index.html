<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (v7.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { 
            position: absolute; left: 15px; top: 10px; bottom: -20px; 
            width: 2px; background-color: #e5e7eb; z-index: 0; 
        }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { 
            position: absolute; left: 0; top: 0; 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; z-index: 10;
        }
        
        /* å°åˆ·ç”¨ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; }
            .shadow-xl, .shadow-md { box-shadow: none !important; border: 1px solid #ddd !important; }
        }
        .print-only { display: none; }
        
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="bg-gray-50 min-h-screen p-2 sm:p-6 text-gray-800">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden print:overflow-visible">
        <div class="print-only text-center py-4 border-b">
            <h1 class="text-3xl font-extrabold text-gray-800">æ—…ã®ã—ãŠã‚Š</h1>
        </div>

        <header class="p-6 bg-indigo-700 text-white shadow-md flex justify-between items-center no-print">
            <h1 class="text-2xl font-extrabold flex items-center gap-2">
                <span>ğŸ—ºï¸</span> æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ <span class="text-xs bg-indigo-500 px-2 py-1 rounded-full">v7.0</span>
            </h1>
            <button onclick="clearData()" class="text-xs text-indigo-200 hover:text-white underline">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
        </header>

        <nav class="flex border-b border-gray-200 bg-gray-50 text-sm font-bold no-print">
            <button onclick="navigate('input')" id="nav-input" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">1. åœ°ç‚¹ãƒ»åŸºç‚¹</button>
            <button onclick="navigate('selection')" id="nav-selection" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">2. ãƒ«ãƒ¼ãƒˆé¸æŠ</button>
            <button onclick="navigate('shiori')" id="nav-shiori" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">3. æ—…ã®ã—ãŠã‚Š</button>
        </nav>

        <main id="app-content" class="p-4 sm:p-8 min-h-[600px] animate-fade-in">
            <div class="text-center p-20 text-gray-400">Loading...</div>
        </main>

        <div id="message-container" class="fixed bottom-4 right-4 z-50 no-print"></div>
    </div>
    <datalist id="saved-locations-list"></datalist>

    <script>
        // --- 0. åˆæœŸåŒ– ---
        function initMap() { console.log("Maps API Loaded"); }
        const APP_VERSION = '7.0';

        // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        const generateDefaultItinerary = () => ({
            version: APP_VERSION,
            planName: "å¤§äººã®ä¼‘æ—¥ãƒ‰ãƒ©ã‚¤ãƒ–",
            baseDateTime: new Date().toISOString().substring(0, 16),
            roundingMinutes: 0,
            gatheringMinutes: 10,
            stops: [
                { id: 's1', name: 'æ±äº¬é§…', location: 'æ±äº¬é§…', isBaseTime: true, stayMinutes: 0, stayReason: '', memo: '' },
                { id: 's2', name: 'æ¸‹è°·é§…', location: 'æ¸‹è°·é§…', isBaseTime: false, stayMinutes: 15, stayReason: 'Bç­åˆæµ', memo: '' },
                { id: 's3', name: 'æµ·ã»ãŸã‚‹PA', location: 'æµ·ã»ãŸã‚‹ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ã‚¨ãƒªã‚¢', isBaseTime: false, stayMinutes: 45, stayReason: 'ä¼‘æ†©', memo: '' },
                { id: 's4', name: 'é¤¨å±±é§…', location: 'é¤¨å±±é§…', isBaseTime: false, stayMinutes: 0, stayReason: '', memo: '' }
            ],
            segments: [],
            currentPage: 'input'
        });

        let itinerary = loadState();
        let savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
        
        function loadState() {
            try {
                const s = JSON.parse(localStorage.getItem('itineraryState'));
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤‰ã‚ã£ã¦ã‚‚é‡è¦ãªãƒ‡ãƒ¼ã‚¿ã¯å¼•ãç¶™ããƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼šæ§‹é€ ãŒå¤‰ã‚ã‚‹ãŸã‚ãƒªã‚»ãƒƒãƒˆæ¨å¥¨ã ãŒã€ä¸¸ã‚è¨­å®šãªã©ã¯ç¶­æŒã—ãŸã„ï¼‰
                if (s && s.version === APP_VERSION) return s;
                return generateDefaultItinerary();
            } catch(e) { return generateDefaultItinerary(); }
        }
        function saveState() {
            localStorage.setItem('itineraryState', JSON.stringify(itinerary));
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
            updateDatalist();
        }

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function addMinutes(iso, m) { const d=new Date(iso); d.setMinutes(d.getMinutes()+m); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function formatTime(iso) { if(!iso) return "--:--"; const d=new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
        function getModeLabel(m) { const l={'DRIVING':'è»Š','WALKING':'å¾’æ­©','BICYCLING':'è‡ªè»¢è»Š','TRANSIT':'é›»è»Š'}; return l[m]||'è»Š'; }
        
        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || "";
        }

        // --- 3. Google API é€£æº ---
        function validateLocation(id) {
            const stop = itinerary.stops.find(s=>s.id===id);
            if(!stop.name) return showAlert('åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');
            showAlert('æ¤œè¨¼ä¸­...', 'info');
            new google.maps.places.AutocompleteService().getPlacePredictions({ input: stop.name }, (preds, status) => {
                if (status === 'OK' && preds.length > 0) {
                    stop.location = preds[0].description;
                    saveState(); renderInputPage();
                    showAlert(`OK: ${stop.name} (ä½æ‰€ç¢ºèªæ¸ˆã¿)`, 'success');
                } else {
                    showAlert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }
            });
        }

        async function fetchRealRoutes(index) {
            const seg = itinerary.segments[index];
            const start = itinerary.stops[index].location;
            const end = itinerary.stops[index+1].location;
            const mode = seg.travelMode || 'DRIVING';
            const depTime = new Date(itinerary.baseDateTime);

            return new Promise((resolve) => {
                const ds = new google.maps.DirectionsService();
                ds.route({
                    origin: start, destination: end, travelMode: mode, 
                    drivingOptions: mode==='DRIVING' ? { departureTime: depTime } : undefined,
                    provideRouteAlternatives: true
                }, (res, status) => {
                    if (status === 'OK') {
                        seg.mockRoutes = res.routes.slice(0,3).map((r, i) => {
                            // æœ‰æ–™é“è·¯åã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–
                            let roadNames = new Set();
                            r.legs[0].steps.forEach(step => {
                                const txt = stripHtml(step.instructions);
                                // æœ‰æ–™é“è·¯ã€é«˜é€Ÿã€è‡ªå‹•è»Šé“ã€ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³ã€ãƒ©ã‚¤ãƒ³ãªã©ã‚’æ¤œçŸ¥
                                if(txt.includes('æœ‰æ–™') || txt.includes('é«˜é€Ÿ') || txt.includes('è‡ªå‹•è»Šé“') || txt.includes('ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³') || txt.includes('æ–™é‡‘æ‰€')) {
                                    // åç§°æŠ½å‡º
                                    const match = txt.match(/([^\sã€Œã€]+(?:é«˜é€Ÿ|è‡ªå‹•è»Šé“|ãƒ©ã‚¤ãƒ³|ã‚¹ã‚«ã‚¤ã‚¦ã‚§ã‚¤|é“è·¯)[^\s]*)/);
                                    if(match) roadNames.add(match[1]);
                                }
                            });
                            
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è©³ç´°ã‹ã‚‰å–ã‚Œãªãã¦ã‚‚Summaryã«ã‚ã‚Œã°å…¥ã‚Œã‚‹
                            if(mode==='DRIVING' && roadNames.size === 0 && (r.summary.includes('é«˜é€Ÿ') || r.summary.includes('æœ‰æ–™'))) {
                                roadNames.add(r.summary);
                            }

                            return {
                                id: `r-${index}-${i}`,
                                label: r.summary,
                                durationMinutes: Math.ceil(r.legs[0].duration.value / 60),
                                desc: stripHtml(r.summary),
                                roads: Array.from(roadNames),
                                overview_path: r.overview_path
                            };
                        });
                        if(!seg.selectedRoute) seg.selectedRoute = seg.mockRoutes[0].id;
                        resolve(true);
                    } else {
                        seg.mockRoutes = [];
                        resolve(false);
                    }
                });
            });
        }

        // --- 4. ç”»é¢æç”» ---
        function navigate(page) {
            itinerary.currentPage = page;
            document.querySelectorAll('#nav-input, #nav-selection, #nav-shiori').forEach(el => {
                el.classList.remove('text-indigo-600', 'border-indigo-600');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            const active = document.getElementById(`nav-${page}`);
            if(active) {
                active.classList.remove('text-gray-500', 'border-transparent');
                active.classList.add('text-indigo-600', 'border-indigo-600');
            }

            if(page === 'input') renderInputPage();
            else if(page === 'selection') renderSelectionPage();
            else if(page === 'shiori') renderSummaryPage();
        }

        // â–  1. å…¥åŠ›ç”»é¢
        function renderInputPage() {
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŒæœŸ
            while(itinerary.segments.length < itinerary.stops.length - 1) itinerary.segments.push({ travelMode: 'DRIVING', mockRoutes: [], selectedRoute: null });

            let h = `
                <div class="space-y-6">
                    <div class="bg-indigo-700 p-4 rounded-xl shadow-lg -mt-2 mb-4">
                        <label class="block text-xs font-bold text-indigo-200 mb-1">ãƒ—ãƒ©ãƒ³å</label>
                        <input type="text" value="${itinerary.planName}" onchange="itinerary.planName=this.value;saveState();" class="w-full p-2 rounded text-lg font-bold text-gray-800" placeholder="ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›">
                    </div>

                    <div class="p-5 bg-white rounded-xl shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">åŸºç‚¹æ—¥æ™‚</label><input type="datetime-local" value="${itinerary.baseDateTime}" onchange="itinerary.baseDateTime=this.value;saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ™‚é–“ä¸¸ã‚</label>
                            <select onchange="updateRounding(this.value)" class="w-full p-2 border rounded bg-gray-50 font-bold">
                                <option value="0" ${itinerary.roundingMinutes===0?'selected':''}>ãªã—</option>
                                <option value="5" ${itinerary.roundingMinutes===5?'selected':''}>5åˆ†å˜ä½</option>
                                <option value="10" ${itinerary.roundingMinutes===10?'selected':''}>10åˆ†å˜ä½</option>
                            </select>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500">é›†åˆæ™‚é–“</label><select onchange="itinerary.gatheringMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold">${[5,10,15,20,30,45,60].map(m=>`<option value="${m}" ${itinerary.gatheringMinutes===m?'selected':''}>${m}åˆ†å‰</option>`).join('')}</select></div>
                    </div>

                    <div class="space-y-4">`;

            itinerary.stops.forEach((s, i) => {
                const isFirst=i===0, isLast=i===itinerary.stops.length-1;
                // è¦‹å‡ºã—ã¨ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³
                const moveUp = !isFirst ? `<button onclick="moveStop(${i}, -1)" class="text-gray-400 hover:text-indigo-600 px-1">â†‘</button>` : '';
                const moveDown = !isLast ? `<button onclick="moveStop(${i}, 1)" class="text-gray-400 hover:text-indigo-600 px-1">â†“</button>` : '';

                h += `
                    <div class="bg-white p-5 rounded-xl border ${s.isBaseTime ? 'border-red-500 ring-2 ring-red-100' : 'border-gray-200'} shadow-sm relative">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800 flex items-center">
                                ${i+1}. ${s.name || 'åœ°ç‚¹'} ${isFirst?'å‡ºç™º':isLast?'åˆ°ç€':'çµŒç”±'}
                                ${s.isBaseTime?'<span class="text-xs bg-red-100 text-red-700 px-2 rounded ml-2 font-bold">â˜… åŸºç‚¹</span>':''}
                            </h3>
                            <div class="flex items-center gap-3">
                                <div class="flex border rounded bg-gray-50">${moveUp}${moveDown}</div>
                                ${(!isFirst && !isLast)?`<button onclick="removeStop(${i})" class="text-red-400 text-sm hover:text-red-600">å‰Šé™¤</button>`:''}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-400">åœ°ç‚¹å</label>
                            <div class="flex gap-2">
                                <input type="text" list="saved-locations-list" value="${s.name}" onchange="updateName(${i}, this.value)" class="flex-1 p-2 border rounded font-bold text-lg" placeholder="ä¾‹: æ±äº¬é§…">
                                <button onclick="validateLocation('${s.id}')" class="bg-indigo-50 text-indigo-600 px-4 rounded font-bold hover:bg-indigo-100">ğŸ” æ¤œè¨¼</button>
                                <button onclick="saveLoc('${s.id}')" class="bg-gray-100 px-3 rounded text-gray-500">ğŸ’¾</button>
                            </div>
                            ${s.location && s.location !== s.name ? `<p class="text-xs text-gray-400 mt-1">â€»Googleæ¤œç´¢ç”¨: ${s.location}</p>` : ''}
                        </div>

                        ${(!isFirst && !isLast) ? `
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨æ™‚é–“ (åˆ†)</label><input type="number" value="${s.stayMinutes}" onchange="itinerary.stops[${i}].stayMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded text-center font-bold"></div>
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨ç†ç”±</label><input type="text" value="${s.stayReason}" onchange="itinerary.stops[${i}].stayReason=this.value;saveState();" class="w-full p-2 border rounded"></div>
                        </div>` : ''}
                        
                        <div class="mb-3"><label class="text-xs font-bold text-gray-400">ãƒ¡ãƒ¢</label><input type="text" value="${s.memo}" onchange="itinerary.stops[${i}].memo=this.value;saveState();" class="w-full p-2 border rounded bg-yellow-50 placeholder-yellow-200" placeholder="ä¾‹: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„æ¸ˆã¿"></div>
                        
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-100">
                            <input type="radio" name="base" ${s.isBaseTime?'checked':''} onchange="setBase(${i})" class="text-red-600 accent-red-600">
                            <span class="text-sm font-bold ${s.isBaseTime?'text-red-600':'text-gray-500'}">ã“ã®æ™‚é–“ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºç‚¹ã«ã™ã‚‹</span>
                        </div>

                        ${!isLast ? `
                        <div class="mt-4 pt-3 bg-gray-50 -mx-5 -mb-5 px-5 pb-4 border-t border-gray-100">
                            <div class="flex items-center gap-3">
                                <p class="text-xs text-gray-400 font-bold">â–¼ ç§»å‹•æ‰‹æ®µ:</p>
                                <div class="flex gap-1">
                                    ${['DRIVING','WALKING','BICYCLING'].map(m => `
                                        <button onclick="changeMode(${i}, '${m}')" class="px-3 py-1 rounded text-sm font-bold transition-all ${itinerary.segments[i]?.travelMode===m ? 'bg-indigo-600 text-white shadow' : 'bg-white border text-gray-500'}">
                                            ${getModeLabel(m)}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>` : ''}
                    </div>`;
            });

            h += `</div>
                  <button onclick="addStop()" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-xl hover:border-indigo-500 hover:text-indigo-500 transition">+ åœ°ç‚¹ã‚’è¿½åŠ </button>
                  <div class="h-10"></div>
                  <button onclick="navigate('selection')" class="w-full py-5 bg-gradient-brand text-white font-extrabold text-xl rounded-2xl shadow-xl hover:opacity-90 transition transform hover:-translate-y-1">æ¬¡ã¸ï¼šãƒ«ãƒ¼ãƒˆé¸æŠ ğŸš€</button>
                </div>`;
            document.getElementById('app-content').innerHTML = h;
        }

        // â–  2. ãƒ«ãƒ¼ãƒˆé¸æŠç”»é¢
        async function renderSelectionPage() {
            const el = document.getElementById('app-content');
            el.innerHTML = '<div class="text-center p-20"><div class="text-2xl font-bold text-indigo-600 mb-2">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</div><p class="text-gray-500">Google Maps APIã¨é€šä¿¡ã—ã¦ã„ã¾ã™</p></div>';

            for(let i=0; i<itinerary.segments.length; i++) {
                if(itinerary.stops[i].location && itinerary.stops[i+1].location) await fetchRealRoutes(i);
            }
            saveState();

            let h = `<h2 class="text-xl font-bold mb-6 text-gray-800">2. ãƒ«ãƒ¼ãƒˆç¢ºèª</h2><div class="space-y-8">`;
            
            itinerary.segments.forEach((seg, i) => {
                const startName = itinerary.stops[i].name;
                const endName = itinerary.stops[i+1].name;
                const modeLabel = getModeLabel(seg.travelMode);
                
                h += `<div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                            <span class="font-bold text-gray-700">åŒºé–“ ${i+1}: ${startName} â†’ ${endName} (${modeLabel})</span>
                        </div>
                        <div class="p-4">`;

                if(!seg.mockRoutes || seg.mockRoutes.length===0) {
                    h += `<p class="text-red-500">ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                } else {
                    h += `<div class="space-y-3 mb-4">`;
                    seg.mockRoutes.forEach(r => {
                        const isSel = r.id === seg.selectedRoute;
                        
                        // æœ‰æ–™é“è·¯ã®ãƒªã‚¹ãƒˆè¡¨ç¤º (ç•ªå·ä»˜ã)
                        let roadsHtml = '';
                        if(r.roads.length > 0) {
                            roadsHtml = `<div class="mt-2 text-xs text-gray-600 bg-gray-50 p-3 rounded border border-gray-200">
                                <p class="font-bold mb-1 text-gray-500">æœ‰æ–™åŒºé–“ã‚ã‚Š:</p>
                                ${r.roads.map((name, idx) => `<div>â‘  ${name}</div>`.replace('â‘ ', ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][idx]||'ãƒ»')).join('')}
                            </div>`;
                        } else if (seg.travelMode === 'DRIVING') {
                             roadsHtml = `<div class="mt-2 text-xs text-green-600 font-bold pl-2">ç„¡æ–™åŒºé–“ / ä¸‹é“</div>`;
                        }

                        h += `<div onclick="selectRoute(${i}, '${r.id}')" class="p-4 border-2 rounded-lg cursor-pointer transition-all ${isSel ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100 hover:border-indigo-300'}">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-bold text-lg text-gray-800">${r.label}</div>
                                        <div class="text-sm text-gray-500">${r.durationMinutes}åˆ†</div>
                                        ${roadsHtml}
                                    </div>
                                    ${isSel ? '<span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">é¸æŠä¸­</span>' : ''}
                                </div>
                              </div>`;
                    });
                    h += `</div><div id="map-area-${i}" class="w-full h-64 bg-gray-200 rounded-lg"></div>`;
                }
                h += `</div></div>`;
            });

            h += `</div>
                  <div class="mt-10 flex gap-4">
                    <button onclick="navigate('input')" class="flex-1 py-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">æˆ»ã‚‹</button>
                    <button onclick="navigate('shiori')" class="flex-[2] py-4 bg-gradient-brand text-white font-bold text-xl rounded-xl shadow-xl hover:opacity-90">æ—…ã®ã—ãŠã‚Šã‚’ä½œæˆ âœ¨</button>
                  </div>`;
            
            el.innerHTML = h;
            itinerary.segments.forEach((seg, i) => { if(seg.mockRoutes.length>0) drawMap(i, seg.selectedRoute); });
        }

        // â–  3. ã—ãŠã‚Šç”»é¢
        function renderSummaryPage() {
            if(!calculateAllSchedule()) return;
            
            let list = []; let c=1;

            itinerary.stops.forEach((s, i) => {
                const isLast = i===itinerary.stops.length-1;
                
                // 1. é›†åˆ/å‡ºç™º/åˆ°ç€/æ»åœ¨
                if(i===0) {
                    const gatherTime = addMinutes(s.departureTime, -itinerary.gatheringMinutes);
                    list.push({ type:'point', idx:c++, time:formatTime(gatherTime), title:`${s.name} é›†åˆ`, sub:'', highlight:true });
                    list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                } else {
                    list.push({ type:'point', idx:c++, time:formatTime(s.arrivalTime), title:`${s.name} åˆ°ç€`, sub:'', highlight:true });
                    
                    if(!isLast) {
                        // æ»åœ¨æƒ…å ±ã®ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´: ç†ç”±ã‚’ãƒ¡ã‚¤ãƒ³ã«ã€æ™‚é–“ã‚’ã‚µãƒ–ã«
                        const reasonTitle = s.stayReason || 'æ»åœ¨';
                        const stayInfo = `<span class="text-lg font-bold text-gray-800">${reasonTitle}</span> <span class="text-sm font-bold text-gray-500 ml-2">æ»åœ¨ ${s.stayMinutes}åˆ†</span>`;
                        const memoHtml = s.memo ? `<div class="mt-1 text-sm text-gray-600">${s.memo}</div>` : '';
                        
                        list.push({ 
                            type:'stay', idx:c++, time:'', 
                            titleHtml: stayInfo, // ç‰¹æ®ŠHTMLã‚¿ã‚¤ãƒˆãƒ«
                            sub:memoHtml, highlight:false 
                        });
                        list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                    }
                }

                // 2. ç§»å‹•
                if(!isLast) {
                    const seg = itinerary.segments[i];
                    const r = seg.mockRoutes.find(x=>x.id===seg.selectedRoute) || {durationMinutes:30, roads:[]};
                    
                    // æœ‰æ–™é“è·¯ãƒªã‚¹ãƒˆ
                    let roadHtml = '';
                    if(r.roads.length > 0) {
                        roadHtml = `<div class="mt-1 text-xs text-gray-500 font-bold">æœ‰æ–™åŒºé–“ã‚ã‚Š</div>`;
                        r.roads.forEach((name, idx) => {
                            const num = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][idx] || 'ãƒ»';
                            roadHtml += `<div class="text-xs text-gray-600 ml-1">${num} ${name}</div>`;
                        });
                    }
                    
                    const navUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(itinerary.stops[i].location)}&destination=${encodeURIComponent(itinerary.stops[i+1].location)}&travelmode=${seg.travelMode.toLowerCase()}`;

                    list.push({ 
                        type: 'move', idx: c++, 
                        time: `<span class="text-xs text-gray-400">${r.durationMinutes}åˆ†</span>`, 
                        title: `${getModeLabel(seg.travelMode)}ç§»å‹•`, 
                        sub: `${roadHtml} <div class="mt-2"><a href="${navUrl}" target="_blank" class="no-print inline-flex items-center gap-1 bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-100">ğŸ§­ ãƒŠãƒ“èµ·å‹•</a></div>`
                    });
                }
            });

            // HTMLç”Ÿæˆ
            const rows = list.map(item => {
                const dotClass = item.type==='point' && item.highlight ? 'bg-indigo-600 text-white shadow-lg scale-110' : 'bg-white border-2 border-indigo-200 text-indigo-600';
                
                let timeClass = "w-16 flex-shrink-0 text-right mr-4 font-bold text-lg text-indigo-900";
                if(item.type==='stay' || item.type==='move') timeClass = "w-16 flex-shrink-0 text-right mr-4 text-sm pt-1";
                
                // ã‚¿ã‚¤ãƒˆãƒ«å‡¦ç† (HTMLå…¥ç¨¿ã«å¯¾å¿œ)
                const titleHtml = item.titleHtml ? item.titleHtml : `<div class="font-bold text-lg text-gray-800">${item.title}</div>`;

                return `
                <div class="timeline-item flex mb-6 relative pl-6">
                    <div class="timeline-line"></div>
                    <div class="timeline-dot ${dotClass} shadow-sm">${item.type==='point' ? 'ğŸ“' : item.type==='move' ? 'ğŸš—' : 'â³'}</div>
                    
                    <div class="ml-8 flex-1">
                        <div class="flex flex-row items-baseline">
                            <div class="${timeClass}">${item.time}</div>
                            <div class="flex-1">
                                ${titleHtml}
                                <div class="mt-1">${item.sub}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 max-w-3xl mx-auto print:shadow-none print:border-none">
                    <div class="text-center mb-10 border-b pb-6">
                        <div class="text-sm font-bold text-gray-400 mb-1">æ—…ã®ã—ãŠã‚Š</div>
                        <h2 class="text-3xl font-extrabold text-indigo-900 mb-2">${itinerary.planName}</h2>
                        <div class="text-gray-500 text-sm">ä½œæˆæ—¥: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <div class="timeline-container">
                        ${rows}
                    </div>
                    
                    <div class="mt-10 pt-6 border-t border-gray-200 page-break-inside-avoid">
                        <h3 class="font-bold text-gray-700 mb-4 text-center">ğŸ—ºï¸ å…¨è¡Œç¨‹ãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
                        <div id="full-map-area" class="w-full h-80 bg-gray-100 rounded-xl shadow-inner print:h-96"></div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4 no-print">
                    <button onclick="navigate('selection')" class="bg-gray-500 text-white px-8 py-3 rounded-full font-bold shadow hover:bg-gray-600">ä¿®æ­£ã™ã‚‹</button> 
                    <button onclick="window.print()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700">å°åˆ· / PDFä¿å­˜ ğŸ–¨ï¸</button>
                </div>
            `;
            
            setTimeout(initFullMap, 500);
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function initFullMap() {
            const div = document.getElementById('full-map-area');
            if(!div) return;
            const map = new google.maps.Map(div, {zoom: 8, center: {lat:35.681, lng:139.767}, disableDefaultUI: true});
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, polylineOptions:{strokeColor:'#4f46e5', strokeWeight:4} });
            
            const waypoints = itinerary.stops.slice(1, itinerary.stops.length-1).map(s => ({ location: s.location, stopover: true }));
            new google.maps.DirectionsService().route({
                origin: itinerary.stops[0].location,
                destination: itinerary.stops[itinerary.stops.length-1].location,
                waypoints: waypoints, travelMode: 'DRIVING'
            }, (res, status) => { if(status==='OK') renderer.setDirections(res); });
        }

        function drawMap(index, routeId) {
            const div = document.getElementById(`map-area-${index}`);
            if(!div) return;
            div.innerHTML = '';
            const seg = itinerary.segments[index];
            const rData = seg.mockRoutes.find(r=>r.id===routeId);
            if(!rData) return;

            const map = new google.maps.Map(div, { zoom: 10, center: {lat:35.681, lng:139.767}, disableDefaultUI:true });
            const polyOpts = {
                strokeColor: '#4f46e5', strokeWeight: 5,
                strokeOpacity: seg.travelMode === 'WALKING' ? 0 : 1.0, 
                icons: seg.travelMode === 'WALKING' ? [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 }, offset: '0', repeat: '20px' }] : undefined
            };
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers:false, polylineOptions: polyOpts });
            
            new google.maps.DirectionsService().route({
                origin: itinerary.stops[index].location, destination: itinerary.stops[index+1].location,
                travelMode: seg.travelMode, provideRouteAlternatives: true
            }, (res, status) => {
                if(status==='OK') {
                    const target = res.routes.find(r => r.overview_path.length === rData.overview_path.length) || res.routes[0];
                    renderer.setDirections({routes:[target], request:res.request});
                }
            });
        }

        function calculateAllSchedule() {
            const baseIdx = itinerary.stops.findIndex(s=>s.isBaseTime);
            if(baseIdx===-1) return false;
            let t = itinerary.baseDateTime;
            // Rounding Check
            const roundMin = itinerary.roundingMinutes || 0; 

            for(let i=baseIdx; i<itinerary.stops.length; i++){
                itinerary.stops[i].arrivalTime = t;
                const roundedStay = roundMinutes(itinerary.stops[i].stayMinutes, roundMin);
                itinerary.stops[i].departureTime = addMinutes(t, roundedStay);
                
                if(i < itinerary.segments.length) {
                    const seg=itinerary.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute);
                    t = addMinutes(itinerary.stops[i].departureTime, r?r.durationMinutes:30);
                }
            }
            t = itinerary.stops[baseIdx].arrivalTime;
            for(let i=baseIdx-1; i>=0; i--){
                const seg=itinerary.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute);
                const dur = r?r.durationMinutes:30;
                itinerary.stops[i].departureTime = addMinutes(itinerary.stops[i+1].arrivalTime, -dur);
                const roundedStay = roundMinutes(itinerary.stops[i].stayMinutes, roundMin);
                itinerary.stops[i].arrivalTime = addMinutes(itinerary.stops[i].departureTime, -roundedStay);
            }
            return true;
        }

        function roundMinutes(m, r) { if(!r) return m; const rem=m%r; return rem===0?m:m+(r-rem); }
        function updateName(i, v) { itinerary.stops[i].name = v; saveState(); }
        function updateRounding(v) { itinerary.roundingMinutes = parseInt(v); saveState(); }
        function selectRoute(i, rid) { itinerary.segments[i].selectedRoute = rid; saveState(); renderSelectionPage(); }
        
        // ä¸¦ã³æ›¿ãˆ (Swap)
        function moveStop(i, dir) {
            if(dir===-1 && i===0) return;
            if(dir===1 && i===itinerary.stops.length-1) return;
            const temp = itinerary.stops[i];
            itinerary.stops[i] = itinerary.stops[i+dir];
            itinerary.stops[i+dir] = temp;
            itinerary.segments = []; // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†æ§‹ç¯‰ãŒå¿…è¦
            saveState(); renderInputPage();
        }

        function addStop(){ itinerary.stops.splice(itinerary.stops.length-1,0,{id:'s'+Date.now(), name:'', location:'', stayMinutes:30}); saveState(); renderInputPage(); }
        function removeStop(i){ itinerary.stops.splice(i,1); itinerary.segments.splice(i,1); saveState(); renderInputPage(); }
        function setBase(i){ itinerary.stops.forEach(s=>s.isBaseTime=false); itinerary.stops[i].isBaseTime=true; saveState(); renderInputPage(); }
        function changeMode(i,m){ itinerary.segments[i].travelMode=m; saveState(); renderInputPage(); }
        function saveLoc(id){ const s=itinerary.stops.find(s=>s.id===id); if(s.name){ savedLocations.push(s.name); saveState(); showAlert('ä¿å­˜ã—ã¾ã—ãŸ','success'); } }
        function updateDatalist(){ const l=document.getElementById('saved-locations-list'); if(l) l.innerHTML=savedLocations.map(x=>`<option value="${x}">`).join(''); }
        function clearData(){ if(confirm('åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('itineraryState'); location.reload(); } }
        function showAlert(m,t){ const c=document.getElementById('message-container'); c.innerHTML=`<div class="px-4 py-2 text-white rounded shadow ${t==='error'?'bg-red-500':'bg-indigo-600'}">${m}</div>`; setTimeout(()=>c.innerHTML='',3000); }

        window.onload = function() { renderInputPage(); }
    </script>
</body>
</html>
