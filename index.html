<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (v5.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { 
            position: absolute; left: 15px; top: 10px; bottom: -20px; 
            width: 2px; background-color: #e5e7eb; z-index: 0; 
        }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { 
            position: absolute; left: 0; top: 0; 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; z-index: 10;
        }
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="bg-gray-50 min-h-screen p-2 sm:p-6 text-gray-800">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden">
        <header class="p-6 bg-indigo-700 text-white shadow-md flex justify-between items-center">
            <h1 class="text-2xl font-extrabold flex items-center gap-2">
                <span>ğŸ—ºï¸</span> æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ <span class="text-xs bg-indigo-500 px-2 py-1 rounded-full">v5.0</span>
            </h1>
            <button onclick="clearData()" class="text-xs text-indigo-200 hover:text-white underline">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
        </header>

        <nav class="flex border-b border-gray-200 bg-gray-50 text-sm font-bold">
            <button onclick="navigate('input')" id="nav-input" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">1. åœ°ç‚¹ãƒ»åŸºç‚¹</button>
            <button onclick="navigate('selection')" id="nav-selection" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">2. ãƒ«ãƒ¼ãƒˆé¸æŠ</button>
            <button onclick="navigate('shiori')" id="nav-shiori" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">3. æ—…ã®ã—ãŠã‚Š</button>
        </nav>

        <main id="app-content" class="p-4 sm:p-8 min-h-[600px] animate-fade-in">
            <div class="text-center p-20 text-gray-400">Loading...</div>
        </main>

        <div id="message-container" class="fixed bottom-4 right-4 z-50"></div>
    </div>
    <datalist id="saved-locations-list"></datalist>

    <script>
        // --- 0. åˆæœŸåŒ– ---
        function initMap() { console.log("Maps API Loaded"); }
        const APP_VERSION = '5.0';

        // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        const generateDefaultItinerary = () => ({
            version: APP_VERSION,
            planName: "å¤§äººã®ä¼‘æ—¥ãƒ‰ãƒ©ã‚¤ãƒ–",
            baseDateTime: new Date().toISOString().substring(0, 16),
            roundingMinutes: 0,
            gatheringMinutes: 10,
            vehicleType: 'STANDARD', // STANDARD, KEI
            stops: [
                { id: 's1', name: 'æ±äº¬é§…', location: 'æ±äº¬é§…', isBaseTime: true, stayMinutes: 0, stayReason: '', memo: '' },
                { id: 's2', name: 'æ¸‹è°·é§…', location: 'æ¸‹è°·é§…', isBaseTime: false, stayMinutes: 15, stayReason: 'Bç­åˆæµ', memo: '' },
                { id: 's3', name: 'ã‚‰ã‚‰ã½ãƒ¼ã¨æ¨ªæµœ', location: 'ã‚‰ã‚‰ã½ãƒ¼ã¨æ¨ªæµœ', isBaseTime: false, stayMinutes: 60, stayReason: 'æ˜¼é£Ÿ', memo: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„æ¸ˆã¿' },
                { id: 's4', name: 'æ¨ªæµœé§…', location: 'æ¨ªæµœé§…', isBaseTime: false, stayMinutes: 0, stayReason: '', memo: '' }
            ],
            segments: [],
            currentPage: 'input'
        });

        let itinerary = loadState();
        let savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
        let mapInstances = {};

        function loadState() {
            try {
                const s = JSON.parse(localStorage.getItem('itineraryState'));
                return (s && s.version === APP_VERSION) ? s : generateDefaultItinerary();
            } catch(e) { return generateDefaultItinerary(); }
        }
        function saveState() {
            localStorage.setItem('itineraryState', JSON.stringify(itinerary));
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
            updateDatalist();
        }

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function addMinutes(iso, m) { const d=new Date(iso); d.setMinutes(d.getMinutes()+m); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function formatTime(iso) { if(!iso) return "--:--"; const d=new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
        
        function getModeLabel(m) { 
            const l={'DRIVING':'è»Š','WALKING':'å¾’æ­©','BICYCLING':'è‡ªè»¢è»Š','TRANSIT':'é›»è»Š'}; 
            return l[m]||'è»Š'; 
        }
        function getVehicleLabel() { return itinerary.vehicleType === 'KEI' ? 'è»½ãƒ»ãƒã‚¤ã‚¯' : 'æ™®é€šè»Š'; }

        // --- 3. Google API é€£æº ---
        // åœ°åæ¤œè¨¼ï¼šå…¥åŠ›å(name)ã¯ãã®ã¾ã¾ã€APIç”¨ä½æ‰€(location)ã‚’æ›´æ–°
        function validateLocation(id) {
            const stop = itinerary.stops.find(s=>s.id===id);
            if(!stop.name) return showAlert('åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');
            
            showAlert(`ã€Œ${stop.name}ã€ã‚’æ¤œç´¢ä¸­...`, 'info');
            const service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({ input: stop.name }, (preds, status) => {
                if (status === 'OK' && preds.length > 0) {
                    stop.location = preds[0].description; // APIç”¨ã®æ­£å¼åç§°/ä½æ‰€
                    // stop.name ã¯æ›¸ãæ›ãˆãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ç¶­æŒï¼‰
                    saveState(); renderInputPage();
                    showAlert(`OK: ${stop.name} (ä½æ‰€ç¢ºèªæ¸ˆã¿)`, 'success');
                } else {
                    showAlert('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…·ä½“çš„ãªåç§°ã§è©¦ã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            });
        }

        // ãƒ«ãƒ¼ãƒˆå–å¾—ï¼ˆæœ‰æ–™é“è·¯åã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯å«ã‚€ï¼‰
        async function fetchRealRoutes(index) {
            const seg = itinerary.segments[index];
            const start = itinerary.stops[index].location; // ä½æ‰€ã§æ¤œç´¢
            const end = itinerary.stops[index+1].location;
            const mode = seg.travelMode || 'DRIVING';
            const depTime = new Date(itinerary.baseDateTime); // å‡ºç™ºæ™‚é–“ã‚’è€ƒæ…®ï¼ˆæ¸‹æ»äºˆæ¸¬ï¼‰

            return new Promise((resolve) => {
                const ds = new google.maps.DirectionsService();
                ds.route({
                    origin: start, destination: end, 
                    travelMode: mode, 
                    drivingOptions: mode==='DRIVING' ? { departureTime: depTime } : undefined,
                    provideRouteAlternatives: true
                }, (res, status) => {
                    if (status === 'OK') {
                        seg.mockRoutes = res.routes.slice(0,3).map((r, i) => {
                            // æœ‰æ–™é“è·¯åã®æŠ½å‡º
                            let roadNames = new Set();
                            r.legs[0].steps.forEach(step => {
                                // æ—¥æœ¬èªã®Instructionsã‹ã‚‰ã€Œã€œé“ã€ã€Œã€œICã€ãªã©ã‚’ç°¡æ˜“æŠ½å‡ºï¼ˆå®Œå…¨ã§ã¯ãªã„ï¼‰
                                const txt = step.instructions;
                                if(txt.includes('æœ‰æ–™é“è·¯') || txt.includes('é«˜é€Ÿ') || txt.includes('IC')) {
                                    // ç°¡æ˜“çš„ãªæ­£è¦è¡¨ç¾ã§é“è·¯åã‚’æ‹¾ã†ï¼ˆæ”¹è‰¯ã®ä½™åœ°ã‚ã‚Šï¼‰
                                    const match = txt.match(/([^\s<]+(?:é«˜é€Ÿ|é“è·¯|ãƒ©ã‚¤ãƒ³|ã‚¹ã‚«ã‚¤ã‚¦ã‚§ã‚¤)[^\s<]*)/);
                                    if(match) roadNames.add(match[1]);
                                }
                            });
                            
                            // æ–™é‡‘æ¨å®š (APIãŒè¿”ã•ãªã„å ´åˆã¯è·é›¢ãƒ™ãƒ¼ã‚¹ã§é©å½“ãªå€¤ã‚’å…¥ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç·¨é›†ã•ã›ã‚‹)
                            const roads = Array.from(roadNames).map(name => ({
                                name: name, 
                                price: 0 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ0ï¼ˆAPIãŒè¿”ã•ãªã„ãŸã‚ï¼‰
                            }));
                            
                            // ã‚‚ã—APIãŒFareã‚’è¿”ã—ãŸã‚‰ï¼ˆç¨€ï¼‰
                            if(r.fare) roads.push({ name: 'åˆè¨ˆæ¨å®š', price: r.fare.value });

                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ‰æ–™é“è·¯ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã®ã«åå‰ãŒå–ã‚Œãªã‹ã£ãŸå ´åˆ
                            if(mode==='DRIVING' && roads.length===0 && (r.summary.includes('æœ‰æ–™') || r.summary.includes('é«˜é€Ÿ'))) {
                                roads.push({name:'æœ‰æ–™åŒºé–“', price:0});
                            }

                            return {
                                id: `r-${index}-${i}`,
                                label: r.summary, // ä¾‹: æ±åé«˜é€Ÿé“è·¯çµŒç”±
                                durationMinutes: Math.ceil(r.legs[0].duration.value / 60),
                                desc: r.summary,
                                roads: roads,
                                overview_path: r.overview_path // åœ°å›³æç”»ç”¨
                            };
                        });
                        if(!seg.selectedRoute) seg.selectedRoute = seg.mockRoutes[0].id;
                        resolve(true);
                    } else {
                        seg.mockRoutes = [];
                        resolve(false);
                    }
                });
            });
        }

        // --- 4. ç”»é¢æç”» ---
        function navigate(page) {
            itinerary.currentPage = page;
            document.querySelectorAll('#nav-input, #nav-selection, #nav-shiori').forEach(el => {
                el.classList.remove('text-indigo-600', 'border-indigo-600');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            const active = document.getElementById(`nav-${page}`);
            active.classList.remove('text-gray-500', 'border-transparent');
            active.classList.add('text-indigo-600', 'border-indigo-600');

            if(page === 'input') renderInputPage();
            else if(page === 'selection') renderSelectionPage();
            else if(page === 'shiori') renderSummaryPage();
        }

        // â–  1. å…¥åŠ›ç”»é¢
        function renderInputPage() {
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
            while(itinerary.segments.length < itinerary.stops.length - 1) itinerary.segments.push({ travelMode: 'DRIVING', mockRoutes: [], selectedRoute: null });

            let h = `
                <div class="space-y-6">
                    <div class="p-5 bg-white rounded-xl shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">åŸºç‚¹æ—¥æ™‚</label><input type="datetime-local" value="${itinerary.baseDateTime}" onchange="itinerary.baseDateTime=this.value;saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold"></div>
                        <div><label class="text-xs font-bold text-gray-500">é›†åˆæ™‚é–“</label><select onchange="itinerary.gatheringMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold">${[5,10,15,20,30,45,60].map(m=>`<option value="${m}" ${itinerary.gatheringMinutes===m?'selected':''}>${m}åˆ†å‰</option>`).join('')}</select></div>
                        <div><label class="text-xs font-bold text-gray-500">è»Šç¨® (æ–™é‡‘è¨ˆç®—ç”¨)</label><select onchange="itinerary.vehicleType=this.value;saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold"><option value="STANDARD" ${itinerary.vehicleType==='STANDARD'?'selected':''}>æ™®é€šè»Š</option><option value="KEI" ${itinerary.vehicleType==='KEI'?'selected':''}>è»½ãƒ»ãƒã‚¤ã‚¯</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500">æ™‚é–“ä¸¸ã‚</label><select onchange="itinerary.roundingMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold"><option value="0">ãªã—</option><option value="5">5åˆ†å˜ä½</option><option value="10">10åˆ†å˜ä½</option></select></div>
                    </div>

                    <div class="space-y-4">`;

            itinerary.stops.forEach((s, i) => {
                const isFirst=i===0, isLast=i===itinerary.stops.length-1;
                // è¦‹å‡ºã—: ç•ªå·. å…¥åŠ›åç§° çŠ¶æ…‹
                const headerTitle = `${i+1}. ${s.name || 'åœ°ç‚¹'} ${isFirst?'å‡ºç™º':isLast?'åˆ°ç€':'çµŒç”±'}`;

                h += `
                    <div class="bg-white p-5 rounded-xl border ${s.isBaseTime ? 'border-indigo-500 ring-1 ring-indigo-500' : 'border-gray-200'} shadow-sm relative">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800">${headerTitle} ${s.isBaseTime?'<span class="text-xs bg-indigo-100 text-indigo-700 px-2 rounded ml-2">åŸºç‚¹</span>':''}</h3>
                            ${(!isFirst && !isLast)?`<button onclick="removeStop(${i})" class="text-red-400 text-sm hover:text-red-600">å‰Šé™¤</button>`:''}
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-400">åœ°ç‚¹å (è¡¨ç¤ºç”¨ãƒ»æ¤œç´¢ç”¨)</label>
                            <div class="flex gap-2">
                                <input type="text" list="saved-locations-list" value="${s.name}" onchange="updateName(${i}, this.value)" class="flex-1 p-2 border rounded font-bold text-lg" placeholder="ä¾‹: æ±äº¬é§…">
                                <button onclick="validateLocation('${s.id}')" class="bg-indigo-50 text-indigo-600 px-4 rounded font-bold hover:bg-indigo-100">ğŸ” æ¤œè¨¼</button>
                                <button onclick="saveLoc('${s.id}')" class="bg-gray-100 px-3 rounded text-gray-500">ğŸ’¾</button>
                            </div>
                            ${s.location && s.location !== s.name ? `<p class="text-xs text-gray-400 mt-1">â€»è¨ˆç®—ç”¨ä½æ‰€: ${s.location}</p>` : ''}
                        </div>

                        ${(!isFirst && !isLast) ? `
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨æ™‚é–“ (åˆ†)</label><input type="number" value="${s.stayMinutes}" onchange="itinerary.stops[${i}].stayMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded text-center font-bold"></div>
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨ç†ç”±</label><input type="text" value="${s.stayReason}" onchange="itinerary.stops[${i}].stayReason=this.value;saveState();" class="w-full p-2 border rounded"></div>
                        </div>` : ''}
                        
                        <div class="mb-3"><label class="text-xs font-bold text-gray-400">ãƒ¡ãƒ¢ (ã—ãŠã‚Šã«è¡¨ç¤º)</label><input type="text" value="${s.memo}" onchange="itinerary.stops[${i}].memo=this.value;saveState();" class="w-full p-2 border rounded bg-yellow-50 placeholder-yellow-200" placeholder="ä¾‹: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„æ¸ˆã¿"></div>
                        
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-100">
                            <input type="radio" name="base" ${s.isBaseTime?'checked':''} onchange="setBase(${i})" class="text-indigo-600">
                            <span class="text-sm font-medium">ã“ã®æ™‚é–“ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºç‚¹ã«ã™ã‚‹</span>
                        </div>

                        ${!isLast ? `
                        <div class="mt-4 pt-3 bg-gray-50 -mx-5 -mb-5 px-5 pb-4 border-t border-gray-100">
                            <p class="text-xs text-center text-gray-400 mb-2">â–¼ æ¬¡ã®åœ°ç‚¹ã¸ã®ç§»å‹•æ‰‹æ®µ â–¼</p>
                            <div class="flex justify-center gap-2">
                                ${['DRIVING','WALKING','BICYCLING'].map(m => `
                                    <button onclick="changeMode(${i}, '${m}')" class="px-4 py-1.5 rounded text-sm font-bold transition-all ${itinerary.segments[i]?.travelMode===m ? 'bg-indigo-600 text-white shadow-md' : 'bg-white border text-gray-500'}">
                                        ${getModeLabel(m)}
                                    </button>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>`;
            });

            h += `</div>
                  <button onclick="addStop()" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-xl hover:border-indigo-500 hover:text-indigo-500 transition">+ åœ°ç‚¹ã‚’è¿½åŠ </button>
                  <div class="h-10"></div>
                  <button onclick="navigate('selection')" class="w-full py-5 bg-gradient-brand text-white font-extrabold text-xl rounded-2xl shadow-xl hover:opacity-90 transition transform hover:-translate-y-1">æ¬¡ã¸ï¼šãƒ«ãƒ¼ãƒˆè¨ˆç®— ğŸš€</button>
                </div>`;
            document.getElementById('app-content').innerHTML = h;
        }

        // â–  2. ãƒ«ãƒ¼ãƒˆé¸æŠç”»é¢
        async function renderSelectionPage() {
            const el = document.getElementById('app-content');
            el.innerHTML = '<div class="text-center p-20"><div class="text-2xl font-bold text-indigo-600 mb-2">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</div><p class="text-gray-500">Google Maps APIã¨é€šä¿¡ã—ã¦ã„ã¾ã™</p></div>';

            for(let i=0; i<itinerary.segments.length; i++) {
                if(itinerary.stops[i].location && itinerary.stops[i+1].location) await fetchRealRoutes(i);
            }
            saveState();

            let h = `<h2 class="text-xl font-bold mb-6 text-gray-800">2. ãƒ«ãƒ¼ãƒˆã¨æ–™é‡‘ã®ç¢ºèª</h2><div class="space-y-8">`;
            
            itinerary.segments.forEach((seg, i) => {
                const startName = itinerary.stops[i].name;
                const endName = itinerary.stops[i+1].name;
                const modeLabel = getModeLabel(seg.travelMode);
                
                h += `<div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                            <span class="font-bold text-gray-700">åŒºé–“ ${i+1}: ${startName} â†’ ${endName} (${modeLabel})</span>
                        </div>
                        <div class="p-4">`;

                if(!seg.mockRoutes || seg.mockRoutes.length===0) {
                    h += `<p class="text-red-500">ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                } else {
                    h += `<div class="space-y-3 mb-4">`;
                    seg.mockRoutes.forEach(r => {
                        const isSel = r.id === seg.selectedRoute;
                        
                        // æœ‰æ–™é“è·¯ã®è¡¨ç¤º
                        let roadsHtml = '';
                        if(r.roads.length > 0) {
                            roadsHtml = `<div class="mt-2 text-xs bg-yellow-50 p-2 rounded border border-yellow-100">
                                <p class="font-bold text-yellow-700 mb-1">æ¤œå‡ºã•ã‚ŒãŸæœ‰æ–™åŒºé–“ (é‡‘é¡ã¯æ¦‚ç®—/æœªå–å¾—):</p>
                                ${r.roads.map((road, ridx) => `
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-gray-600">ãƒ»${road.name}</span>
                                        <input type="number" placeholder="é‡‘é¡å…¥åŠ›" value="${road.price}" 
                                            onchange="updateRoadPrice(${i}, '${r.id}', ${ridx}, this.value)" 
                                            class="w-20 p-1 border rounded text-right text-xs" onclick="event.stopPropagation()">
                                        <span class="text-gray-400 text-xs">å††</span>
                                    </div>
                                `).join('')}
                            </div>`;
                        }

                        h += `<div onclick="selectRoute(${i}, '${r.id}')" class="p-4 border-2 rounded-lg cursor-pointer transition-all ${isSel ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100 hover:border-indigo-300'}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-lg text-gray-800">${r.label}</div>
                                        <div class="text-sm text-gray-500">${r.durationMinutes}åˆ† / ${r.roads.length>0 ? 'æœ‰æ–™åŒºé–“ã‚ã‚Š' : 'ç„¡æ–™å„ªå…ˆ'}</div>
                                    </div>
                                    ${isSel ? '<span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">é¸æŠä¸­</span>' : ''}
                                </div>
                                ${roadsHtml}
                              </div>`;
                    });
                    h += `</div><div id="map-area-${i}" class="w-full h-64 bg-gray-200 rounded-lg"></div>`;
                }
                h += `</div></div>`;
            });

            h += `</div>
                  <div class="mt-10 flex gap-4">
                    <button onclick="navigate('input')" class="flex-1 py-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">æˆ»ã‚‹</button>
                    <button onclick="navigate('shiori')" class="flex-[2] py-4 bg-gradient-brand text-white font-bold text-xl rounded-xl shadow-xl hover:opacity-90">æ—…ã®ã—ãŠã‚Šã‚’ä½œæˆ âœ¨</button>
                  </div>`;
            
            el.innerHTML = h;
            // åœ°å›³æç”»
            itinerary.segments.forEach((seg, i) => { if(seg.mockRoutes.length>0) drawMap(i, seg.selectedRoute); });
        }

        // â–  3. ã—ãŠã‚Šç”»é¢ (ãƒ‡ã‚¶ã‚¤ãƒ³åˆ·æ–°)
        function renderSummaryPage() {
            if(!calculateAllSchedule()) return;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆç”Ÿæˆ
            let list = []; let c=1;
            const vehicleCoef = itinerary.vehicleType === 'KEI' ? 0.8 : 1.0; // è»½è‡ªå‹•è»Šä¿‚æ•°

            itinerary.stops.forEach((s, i) => {
                const isLast = i===itinerary.stops.length-1;
                
                // 1. é›†åˆ/å‡ºç™º/åˆ°ç€/æ»åœ¨
                if(i===0) {
                    const gatherTime = addMinutes(s.departureTime, -itinerary.gatheringMinutes);
                    list.push({ type:'point', idx:c++, time:formatTime(gatherTime), title:`${s.name} é›†åˆ`, sub:'', highlight:true });
                    list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                } else {
                    list.push({ type:'point', idx:c++, time:formatTime(s.arrivalTime), title:`${s.name} åˆ°ç€`, sub:'', highlight:true });
                    
                    if(!isLast) {
                        const memoHtml = s.memo ? `<div class="mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-gray-700">ğŸ“ ${s.memo}</div>` : '';
                        list.push({ type:'stay', idx:c++, time:`(æ»åœ¨${s.stayMinutes}åˆ†)`, title:`${s.stayReason || 'æ»åœ¨'}`, sub:memoHtml, highlight:false });
                        list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                    }
                }

                // 2. ç§»å‹• (æœ‰æ–™é“è·¯æƒ…å ±)
                if(!isLast) {
                    const seg = itinerary.segments[i];
                    const r = seg.mockRoutes.find(x=>x.id===seg.selectedRoute) || {durationMinutes:30, roads:[]};
                    
                    let tollHtml = '';
                    if(r.roads.length > 0) {
                        tollHtml = `<div class="mt-2 text-xs text-gray-600 bg-gray-50 p-2 rounded">`;
                        r.roads.forEach((road, ri) => {
                            const price = parseInt(road.price) || 0;
                            const keiPrice = Math.floor(price * 0.8);
                            const priceStr = price > 0 ? `${price}å†† (è»½${keiPrice}å††)` : 'æ–™é‡‘ä¸æ˜';
                            tollHtml += `<div class="flex justify-between border-b border-gray-200 last:border-0 py-1"><span>${ri+1}. ${road.name}</span><span>${priceStr}</span></div>`;
                        });
                        tollHtml += `</div>`;
                    }

                    list.push({ 
                        type: 'move', idx: c++, 
                        time: `${r.durationMinutes}åˆ†`, 
                        title: `${getModeLabel(seg.travelMode)}ç§»å‹•`, 
                        sub: tollHtml 
                    });
                }
            });

            // HTMLç”Ÿæˆ
            const rows = list.map(item => {
                const num = item.idx < 10 ? `0${item.idx}` : item.idx; // 01, 02...
                const dotClass = item.type==='point' && item.highlight ? 'bg-indigo-600 text-white shadow-lg scale-110' : 'bg-white border-2 border-indigo-200 text-indigo-600';
                const timeStyle = item.type==='move' ? 'text-gray-400 text-sm' : 'text-lg font-bold text-indigo-900';
                
                return `
                <div class="timeline-item flex mb-6 relative pl-6">
                    <div class="timeline-line"></div>
                    <div class="timeline-dot ${dotClass} shadow-sm">${item.type==='point' ? 'ğŸ“' : item.type==='move' ? 'ğŸš—' : 'â³'}</div>
                    
                    <div class="ml-8 flex-1">
                        <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 mb-1">
                            <div class="w-20 flex-shrink-0 ${timeStyle}">${item.time}</div>
                            <div class="font-bold text-lg text-gray-800">${item.title}</div>
                        </div>
                        <div class="ml-0 sm:ml-22 text-sm text-gray-600 pl-0 sm:pl-20">
                            ${item.sub}
                        </div>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('app-content').innerHTML = `
                <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 max-w-3xl mx-auto print:shadow-none">
                    <div class="text-center mb-10 border-b pb-6">
                        <h2 class="text-3xl font-extrabold text-indigo-900 mb-2">ğŸ“… ${itinerary.planName}</h2>
                        <div class="text-gray-500 text-sm">ä½œæˆæ—¥: ${new Date().toLocaleDateString()} / è»Šç¨®: ${getVehicleLabel()}</div>
                    </div>
                    <div class="timeline-container">
                        ${rows}
                    </div>
                    
                    <div class="mt-10 pt-6 border-t border-gray-200">
                        <h3 class="font-bold text-gray-700 mb-4 text-center">ğŸ—ºï¸ å…¨è¡Œç¨‹ãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3>
                        <div id="full-map-area" class="w-full h-80 bg-gray-100 rounded-xl shadow-inner"></div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-center gap-4 print:hidden">
                    <button onclick="navigate('selection')" class="bg-gray-500 text-white px-8 py-3 rounded-full font-bold shadow hover:bg-gray-600">ä¿®æ­£ã™ã‚‹</button> 
                    <button onclick="window.print()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700">å°åˆ· / PDFä¿å­˜ ğŸ–¨ï¸</button>
                </div>
            `;
            
            // å…¨ä½“åœ°å›³ã‚’æç”»
            setTimeout(initFullMap, 500);
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

        // å…¨è¡Œç¨‹åœ°å›³
        function initFullMap() {
            const div = document.getElementById('full-map-area');
            if(!div) return;
            const map = new google.maps.Map(div, {zoom: 8, center: {lat:35.681, lng:139.767}, disableDefaultUI: true});
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, polylineOptions:{strokeColor:'#4f46e5', strokeWeight:4} });
            
            // Waypointsã‚’ä½¿ã£ãŸä¸€æ‹¬ãƒ«ãƒ¼ãƒˆæ¤œç´¢
            const waypoints = itinerary.stops.slice(1, itinerary.stops.length-1).map(s => ({ location: s.location, stopover: true }));
            new google.maps.DirectionsService().route({
                origin: itinerary.stops[0].location,
                destination: itinerary.stops[itinerary.stops.length-1].location,
                waypoints: waypoints,
                travelMode: 'DRIVING' // å…¨ä½“å›³ã¯è»Šãƒ™ãƒ¼ã‚¹ã§è¡¨ç¤º
            }, (res, status) => {
                if(status==='OK') renderer.setDirections(res);
            });
        }

        // å€‹åˆ¥ãƒ«ãƒ¼ãƒˆåœ°å›³ (å¾’æ­©ã¯ç‚¹ç·š)
        function drawMap(index, routeId) {
            const div = document.getElementById(`map-area-${index}`);
            if(!div) return;
            div.innerHTML = '';
            const seg = itinerary.segments[index];
            const rData = seg.mockRoutes.find(r=>r.id===routeId);
            if(!rData) return;

            const map = new google.maps.Map(div, { zoom: 10, center: {lat:35.681, lng:139.767}, disableDefaultUI:true });
            
            // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ« (å¾’æ­©ã¯ç‚¹ç·š)
            const polyOpts = {
                strokeColor: '#4f46e5', strokeWeight: 5,
                strokeOpacity: seg.travelMode === 'WALKING' ? 0 : 1.0, // å¾’æ­©ãªã‚‰ç·šã‚’é€æ˜ã«
                icons: seg.travelMode === 'WALKING' ? [{
                    icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 },
                    offset: '0', repeat: '20px'
                }] : undefined
            };

            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers:false, polylineOptions: polyOpts });
            
            new google.maps.DirectionsService().route({
                origin: itinerary.stops[index].location, destination: itinerary.stops[index+1].location,
                travelMode: seg.travelMode, provideRouteAlternatives: true
            }, (res, status) => {
                if(status==='OK') {
                    const target = res.routes.find(r => r.summary === rData.desc) || res.routes[0];
                    renderer.setDirections({routes:[target], request:res.request});
                }
            });
        }

        function calculateAllSchedule() {
            const baseIdx = itinerary.stops.findIndex(s=>s.isBaseTime);
            if(baseIdx===-1) return false;
            let t = itinerary.baseDateTime;
            for(let i=baseIdx; i<itinerary.stops.length; i++){
                itinerary.stops[i].arrivalTime = t;
                itinerary.stops[i].departureTime = addMinutes(t, itinerary.stops[i].stayMinutes);
                if(i < itinerary.segments.length) {
                    const seg=itinerary.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute);
                    t = addMinutes(itinerary.stops[i].departureTime, r?r.durationMinutes:30);
                }
            }
            t = itinerary.stops[baseIdx].arrivalTime;
            for(let i=baseIdx-1; i>=0; i--){
                const seg=itinerary.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute);
                const dur = r?r.durationMinutes:30;
                itinerary.stops[i].departureTime = addMinutes(itinerary.stops[i+1].arrivalTime, -dur);
                itinerary.stops[i].arrivalTime = addMinutes(itinerary.stops[i].departureTime, -itinerary.stops[i].stayMinutes);
            }
            return true;
        }

        function updateName(i, v) { itinerary.stops[i].name = v; saveState(); }
        function updateRoadPrice(segIdx, routeId, roadIdx, price) {
            const r = itinerary.segments[segIdx].mockRoutes.find(r=>r.id===routeId);
            if(r) r.roads[roadIdx].price = parseInt(price) || 0;
            saveState();
        }
        function selectRoute(i, rid) { itinerary.segments[i].selectedRoute = rid; saveState(); renderSelectionPage(); }
        
        function addStop(){ itinerary.stops.splice(itinerary.stops.length-1,0,{id:'s'+Date.now(), name:'', location:'', stayMinutes:30}); saveState(); renderInputPage(); }
        function removeStop(i){ itinerary.stops.splice(i,1); itinerary.segments.splice(i,1); saveState(); renderInputPage(); }
        function setBase(i){ itinerary.stops.forEach(s=>s.isBaseTime=false); itinerary.stops[i].isBaseTime=true; saveState(); renderInputPage(); }
        function changeMode(i,m){ itinerary.segments[i].travelMode=m; saveState(); renderInputPage(); }
        function saveLoc(id){ const s=itinerary.stops.find(s=>s.id===id); if(s.name){ savedLocations.push(s.name); saveState(); showAlert('ä¿å­˜ã—ã¾ã—ãŸ','success'); } }
        function updateDatalist(){ const l=document.getElementById('saved-locations-list'); if(l) l.innerHTML=savedLocations.map(x=>`<option value="${x}">`).join(''); }
        function clearData(){ if(confirm('åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('itineraryState'); location.reload(); } }
        function showAlert(m,t){ const c=document.getElementById('message-container'); c.innerHTML=`<div class="px-4 py-2 text-white rounded shadow ${t==='error'?'bg-red-500':'bg-indigo-600'}">${m}</div>`; setTimeout(()=>c.innerHTML='',3000); }

        window.onload = function() { renderInputPage(); }
    </script>
</body>
</html>
