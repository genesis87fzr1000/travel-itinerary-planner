<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (v3.0 Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        .draggable-item { cursor: grab; transition: all 0.2s; }
        .dragging { opacity: 0.5; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* ã—ãŠã‚Šç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .shiori-row {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .shiori-num {
            flex-shrink: 0;
            width: 50px;
            font-weight: 800;
            color: #4f46e5;
        }
        .shiori-content {
            flex-grow: 1;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen p-2 sm:p-6 text-gray-800">

    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden">
        <header class="p-6 bg-indigo-700 text-white shadow-xl flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-extrabold flex items-center gap-2">
                <span>ğŸ—ºï¸</span> æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼
                <span class="text-xs bg-indigo-500 px-2 py-1 rounded-full uppercase tracking-wider">v3.0</span>
            </h1>
            <button onclick="clearData()" class="text-xs text-indigo-200 hover:text-white underline">ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–</button>
        </header>

        <main id="app-content" class="p-4 sm:p-8 min-h-[500px]">
            <div class="text-center p-10 text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
        </main>

        <div id="message-container" class="fixed bottom-4 right-4 z-50 w-full max-w-sm px-4"></div>
    </div>

    <datalist id="saved-locations-list"></datalist>

    <script>
        // ===============================================
        // 0. Google Maps API åˆæœŸåŒ–
        // ===============================================
        function initMap() {
            console.log("Google Maps API Loaded successfully.");
        }

        // ===============================================
        // 1. çŠ¶æ…‹ç®¡ç† (State)
        // ===============================================
        const APP_VERSION = '3.0';

        const generateDefaultItinerary = () => ({
            version: APP_VERSION,
            planName: "æ–°è¦æ—…ç¨‹ãƒ—ãƒ©ãƒ³ " + new Date().toLocaleDateString('ja-JP'),
            baseDateTime: new Date().toISOString().substring(0, 16),
            roundingMinutes: 0,
            gatheringMinutes: 10,
            stops: [
                { id: 's-start', location: 'æ±äº¬é§…', isBaseTime: true, isFixed: true, stayMinutes: 0, stayReason: '', memo: '' },
                { id: 's-way1', location: 'æ¸‹è°·é§…', isBaseTime: false, isFixed: false, stayMinutes: 15, stayReason: 'Bç­å¾…ã¡åˆã‚ã›', memo: '' },
                { id: 's-end', location: 'æ¨ªæµœé§…', isBaseTime: false, isFixed: true, stayMinutes: 0, stayReason: '', memo: '' }
            ],
            segments: [], 
            currentPage: 'input'
        });

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadState() {
            try {
                const saved = JSON.parse(localStorage.getItem('itineraryState'));
                if (!saved || saved.version !== APP_VERSION) return generateDefaultItinerary();
                return saved;
            } catch (e) { return generateDefaultItinerary(); }
        }

        let itinerary = loadState();
        let savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || ['æ±äº¬é§…', 'æ–°å®¿é§…', 'æ¨ªæµœä¸­è¯è¡—'];
        let mapInstances = {}; // ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿æŒç”¨

        function saveState() {
            itinerary.version = APP_VERSION;
            localStorage.setItem('itineraryState', JSON.stringify(itinerary));
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
            updateDatalist();
        }
        
        function updateDatalist() {
            const datalist = document.getElementById('saved-locations-list');
            if(datalist) datalist.innerHTML = savedLocations.map(loc => `<option value="${loc}">`).join('');
        }

        function clearData() {
            if(confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('itineraryState');
                location.reload();
            }
        }

        // ===============================================
        // 2. ãƒ­ã‚¸ãƒƒã‚¯ & è¨ˆç®— (Logic)
        // ===============================================

        function addMinutesToISO(isoString, minutes) {
            const date = new Date(isoString);
            date.setMinutes(date.getMinutes() + minutes);
            const tzOffset = date.getTimezoneOffset() * 60000; 
            return (new Date(date - tzOffset)).toISOString().slice(0, 16);
        }

        function formatDisplayTime(isoString) {
            if (!isoString) return "--:--";
            const date = new Date(isoString);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function roundMinutes(minutes, rounding) {
            if (!rounding || rounding === 0) return minutes;
            const remainder = minutes % rounding;
            return remainder === 0 ? minutes : minutes + (rounding - remainder);
        }

        function getTravelModeLabel(mode) {
            const labels = { 'DRIVING': 'è»Šç§»å‹•', 'WALKING': 'å¾’æ­©ç§»å‹•', 'BICYCLING': 'è‡ªè»¢è»Šç§»å‹•', 'TRANSIT': 'å…¬å…±äº¤é€šæ©Ÿé–¢' };
            return labels[mode] || labels['DRIVING'];
        }

        // â˜…â˜…â˜… Places API æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
        function validateLocation(id) {
            const stop = itinerary.stops.find(s => s.id === id);
            const location = stop.location;
            if(!location) {
                showAlert('åœ°ç‚¹åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            showAlert(`ã€Œ${location}ã€ã‚’Googleã§æ¤œè¨¼ä¸­...`, 'info');
            const service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({ input: location }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions.length > 0) {
                    showAlert(`âœ… OK: ã€Œ${predictions[0].description}ã€ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚`, 'success');
                    stop.location = predictions[0].description;
                    saveState(); 
                    renderInputPage(document.getElementById('app-content'));
                } else {
                    showAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ã€Œ${location}ã€ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`, 'error');
                }
            });
        }

        // â˜…â˜…â˜… Directions API ãƒ«ãƒ¼ãƒˆå–å¾—ãƒ­ã‚¸ãƒƒã‚¯
        function getRealRoutes(fromStop, toStop, segIndex, mode) {
            const directionsService = new google.maps.DirectionsService();
            return new Promise((resolve, reject) => {
                directionsService.route(
                    {
                        origin: fromStop.location,
                        destination: toStop.location,
                        travelMode: mode || 'DRIVING',
                        provideRouteAlternatives: true
                    },
                    (response, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            const newRoutes = response.routes.slice(0, 3).map((route, i) => {
                                const leg = route.legs[0];
                                const durationMinutes = Math.ceil(leg.duration.value / 60);
                                const tolls = [];
                                // æ–™é‡‘æƒ…å ±ã®ç°¡æ˜“æŠ½å‡º
                                if (mode === 'DRIVING' && route.summary.includes('æœ‰æ–™')) {
                                     tolls.push({ name: 'æœ‰æ–™åŒºé–“', standard: 1000, kei: 700 });
                                }
                                return {
                                    id: `r${i + 1}`,
                                    label: `å€™è£œ ${i + 1}`,
                                    durationMinutes: durationMinutes,
                                    tolls: tolls,
                                    desc: route.summary || 'æ¨å¥¨ãƒ«ãƒ¼ãƒˆ'
                                };
                            });
                            itinerary.segments[segIndex].mockRoutes = newRoutes;
                            itinerary.segments[segIndex].selectedRoute = newRoutes.length > 0 ? newRoutes[0].id : null;
                            resolve();
                        } else {
                            itinerary.segments[segIndex].mockRoutes = [];
                            reject(status);
                        }
                    }
                );
            });
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®— (æ­£ç®—ãƒ»é€†ç®—)
        function calculateAllSchedule() {
            const baseIndex = itinerary.stops.findIndex(s => s.isBaseTime);
            if (baseIndex === -1) return false;

            // Forward
            let currentTime = itinerary.baseDateTime;
            for (let i = baseIndex; i < itinerary.stops.length; i++) {
                const stop = itinerary.stops[i];
                stop.arrivalTime = currentTime;
                const roundedStay = roundMinutes(stop.stayMinutes, itinerary.roundingMinutes);
                stop.departureTime = addMinutesToISO(stop.arrivalTime, roundedStay);

                if (i < itinerary.stops.length - 1) {
                    if (!itinerary.segments[i]) initSegment(i);
                    const seg = itinerary.segments[i];
                    let duration = 30;
                    if (seg.mockRoutes && seg.mockRoutes.length > 0) {
                        const route = seg.selectedRoute ? seg.mockRoutes.find(r => r.id === seg.selectedRoute) : seg.mockRoutes[0];
                        duration = route ? route.durationMinutes : 30;
                    }
                    currentTime = addMinutesToISO(stop.departureTime, duration);
                }
            }
            // Backward
            currentTime = itinerary.stops[baseIndex].arrivalTime; 
            for (let i = baseIndex - 1; i >= 0; i--) {
                const nextStop = itinerary.stops[i+1];
                const seg = itinerary.segments[i];
                if (!seg) initSegment(i);
                let duration = 30;
                if (seg.mockRoutes && seg.mockRoutes.length > 0) {
                    const route = seg.selectedRoute ? seg.mockRoutes.find(r => r.id === seg.selectedRoute) : seg.mockRoutes[0];
                    duration = route ? route.durationMinutes : 30;
                }
                const currentDeparture = addMinutesToISO(nextStop.arrivalTime, -duration);
                itinerary.stops[i].departureTime = currentDeparture;
                const roundedStay = roundMinutes(itinerary.stops[i].stayMinutes, itinerary.roundingMinutes);
                itinerary.stops[i].arrivalTime = addMinutesToISO(currentDeparture, -roundedStay);
            }
            return true;
        }

        function initSegment(index) {
            itinerary.segments[index] = {
                id: `seg-${index}`,
                travelMode: 'DRIVING',
                selectedRoute: null,
                mockRoutes: []
            };
        }

        // ===============================================
        // 3. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© (Handlers)
        // ===============================================
        
        function addStop() {
            const newStop = { id: 's-' + Math.random().toString(36).substr(2, 9), location: '', isBaseTime: false, isFixed: false, stayMinutes: 30, stayReason: '', memo: '' };
            itinerary.stops.splice(itinerary.stops.length - 1, 0, newStop);
            itinerary.segments.push(null);
            saveState();
            renderInputPage(document.getElementById('app-content'));
        }

        function removeStop(index) {
            itinerary.stops.splice(index, 1);
            itinerary.segments.splice(index, 1); // å¯¾å¿œã™ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚‚å‰Šé™¤
            saveState();
            renderInputPage(document.getElementById('app-content'));
        }

        function updateLocation(id, val) { itinerary.stops.find(s => s.id === id).location = val; saveState(); }
        
        function updateMode(index, mode) {
            if(!itinerary.segments[index]) initSegment(index);
            itinerary.segments[index].travelMode = mode;
            showAlert('ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ä¸­...', 'info');
            getRealRoutes(itinerary.stops[index], itinerary.stops[index+1], index, mode)
                .then(() => {
                    saveState();
                    renderInputPage(document.getElementById('app-content'));
                    showAlert('ãƒ«ãƒ¼ãƒˆæ›´æ–°å®Œäº†', 'success');
                })
                .catch(e => showAlert('ãƒ«ãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + e, 'error'));
        }

        function saveLocation(id) {
            const val = itinerary.stops.find(s => s.id === id).location;
            if(val && !savedLocations.includes(val)){
                savedLocations.push(val);
                saveState();
                showAlert(`ã€Œ${val}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, 'success');
            }
        }

        // â˜…â˜…â˜… åœ°å›³è¡¨ç¤ºã¨ãƒ«ãƒ¼ãƒˆæç”» (initMapDisplay)
        function initMapDisplay(segIndex, routeId) {
            const segment = itinerary.segments[segIndex];
            const mapElement = document.getElementById(`map-area-${segIndex}`);
            
            if (!mapElement) return;
            if (!segment.mockRoutes || segment.mockRoutes.length === 0) {
                mapElement.innerHTML = '<p class="p-4 text-center text-gray-500">ãƒ«ãƒ¼ãƒˆæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                map: mapInstances[segIndex], 
                suppressMarkers: false, 
                polylineOptions: { strokeColor: '#4F46E5', strokeWeight: 5 }
            });

            if (!mapInstances[segIndex]) {
                const map = new google.maps.Map(mapElement, {
                    zoom: 10,
                    center: { lat: 35.681, lng: 139.767 },
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false
                });
                mapInstances[segIndex] = map;
                directionsRenderer.setMap(map);
            }
            
            const selectedRoute = segment.mockRoutes.find(r => r.id === routeId);
            if (!selectedRoute) return;

            directionsService.route(
                {
                    origin: itinerary.stops[segIndex].location,
                    destination: itinerary.stops[segIndex+1].location,
                    travelMode: segment.travelMode || 'DRIVING',
                    provideRouteAlternatives: true
                },
                (response, status) => {
                    if (status === google.maps.DirectionsStatus.OK) {
                        const targetIndex = response.routes.findIndex(r => r.summary === selectedRoute.desc);
                        const idx = targetIndex !== -1 ? targetIndex : 0;
                        directionsRenderer.setDirections({ routes: [response.routes[idx]], status: 'OK' });
                    }
                }
            );
        }

        // â˜…â˜…â˜… ãƒ«ãƒ¼ãƒˆé¸æŠæ™‚ã®å‡¦ç† (selectRoute)
        function selectRoute(segIndex, routeId) {
            itinerary.segments[segIndex].selectedRoute = routeId;
            saveState();
            // ç”»é¢ã‚’å†æç”»ï¼ˆåœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ï¼‰ã—ã¦ã‹ã‚‰åœ°å›³ã‚’æç”»
            renderRoutePage(segIndex); 
        }

        function showAlert(msg, type='info') {
            const el = document.getElementById('message-container');
            const color = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-600' : 'bg-indigo-600';
            el.innerHTML = `<div class="${color} text-white px-6 py-3 rounded-full shadow-lg text-center font-bold text-sm">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        // ===============================================
        // 4. æç”» (Render)
        // ===============================================

        /** 1. åœ°ç‚¹å…¥åŠ›ç”»é¢ */
        function renderInputPage(appContent) {
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§
            if (itinerary.segments.length < itinerary.stops.length - 1) {
                itinerary.segments = new Array(itinerary.stops.length - 1).fill(null);
            }
            const gatheringOptions = [{v:5, l:'5åˆ†å‰'}, {v:10, l:'10åˆ†å‰'}, {v:20, l:'20åˆ†å‰'}, {v:30, l:'30åˆ†å‰'}];

            let html = `
                <div class="space-y-6 animate-fade-in">
                    <div class="p-5 bg-indigo-50 rounded-xl border border-indigo-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">åŸºç‚¹æ—¥æ™‚</label>
                            <input type="datetime-local" value="${itinerary.baseDateTime}" onchange="itinerary.baseDateTime=this.value; saveState();" class="w-full p-2 border rounded font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ãƒãƒƒãƒ•ã‚¡</label>
                            <select onchange="itinerary.roundingMinutes=parseInt(this.value); saveState();" class="w-full p-2 border rounded font-bold">
                                <option value="0" ${itinerary.roundingMinutes===0?'selected':''}>ãªã—</option>
                                <option value="5" ${itinerary.roundingMinutes===5?'selected':''}>5åˆ†</option>
                                <option value="10" ${itinerary.roundingMinutes===10?'selected':''}>10åˆ†</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é›†åˆæ™‚é–“</label>
                            <select onchange="itinerary.gatheringMinutes=parseInt(this.value); saveState();" class="w-full p-2 border rounded font-bold">
                                ${gatheringOptions.map(o => `<option value="${o.v}" ${itinerary.gatheringMinutes===o.v?'selected':''}>${o.l}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
            `;

            itinerary.stops.forEach((stop, index) => {
                const isFirst = index === 0;
                const isLast = index === itinerary.stops.length - 1;
                
                html += `
                    <div class="bg-white p-5 rounded-xl shadow-sm border ${stop.isBaseTime ? 'border-green-500 ring-2 ring-green-100' : 'border-gray-200'}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-2">
                                <span class="bg-gray-800 text-white text-xs font-bold px-2 py-1 rounded">${index + 1}</span>
                                <span class="font-bold text-lg">${isFirst ? 'å‡ºç™ºåœ°' : isLast ? 'ç›®çš„åœ°' : 'çµŒç”±åœ°'}</span>
                                ${stop.isBaseTime ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">åŸºç‚¹</span>' : ''}
                            </div>
                            ${!isFirst && !isLast ? `<button onclick="removeStop(${index})" class="text-red-500 text-sm hover:underline">å‰Šé™¤</button>` : ''}
                        </div>
                        
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-400">åœ°ç‚¹å</label>
                            <div class="flex gap-2">
                                <input type="text" list="saved-locations-list" value="${stop.location}" onchange="updateLocation('${stop.id}', this.value)" class="flex-1 p-2 border rounded font-bold" placeholder="åœ°ç‚¹å">
                                <button onclick="validateLocation('${stop.id}')" class="bg-indigo-50 text-indigo-600 px-3 rounded font-bold">ğŸ” æ¤œè¨¼</button>
                                <button onclick="saveLocation('${stop.id}')" class="bg-gray-100 text-gray-600 px-3 rounded">ğŸ’¾</button>
                            </div>
                        </div>

                        ${!isFirst && !isLast ? `
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨(åˆ†)</label><input type="number" value="${stop.stayMinutes}" onchange="itinerary.stops[${index}].stayMinutes=parseInt(this.value); saveState();" class="w-full p-2 border rounded text-center"></div>
                            <div><label class="text-xs font-bold text-gray-400">ç†ç”±</label><input type="text" value="${stop.stayReason}" onchange="itinerary.stops[${index}].stayReason=this.value; saveState();" class="w-full p-2 border rounded"></div>
                        </div>` : ''}
                        
                        <div class="mb-3"><label class="text-xs font-bold text-gray-400">ãƒ¡ãƒ¢</label><input type="text" value="${stop.memo}" onchange="itinerary.stops[${index}].memo=this.value; saveState();" class="w-full p-2 border rounded bg-yellow-50"></div>
                        
                        <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="base" ${stop.isBaseTime?'checked':''} onchange="itinerary.stops.forEach(s=>s.isBaseTime=false); itinerary.stops[${index}].isBaseTime=true; saveState(); renderInputPage(document.getElementById('app-content'));"> ã“ã®æ™‚é–“ã‚’åŸºç‚¹ã«ã™ã‚‹</label>

                        ${!isLast ? `
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <p class="text-xs text-center text-gray-400 mb-2">â–¼ æ¬¡ã®ç§»å‹•æ‰‹æ®µ â–¼</p>
                            <div class="flex justify-center gap-2">
                                ${['DRIVING','WALKING','BICYCLING'].map(m => `
                                    <button onclick="updateMode(${index}, '${m}')" class="px-3 py-1 rounded border text-sm ${itinerary.segments[index]?.travelMode===m ? 'bg-indigo-600 text-white' : 'bg-white text-gray-500'}">${getTravelModeLabel(m)}</button>
                                `).join('')}
                            </div>
                            ${itinerary.segments[index] && itinerary.stops[index].location && itinerary.stops[index+1].location ? `
                                <button onclick="renderRoutePage(${index})" class="w-full mt-2 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700">æ¬¡ã¸ï¼šãƒ«ãƒ¼ãƒˆè¨ˆç®— ğŸš€</button>
                            ` : ''}
                        </div>` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                    <button onclick="addStop()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-xl hover:text-indigo-500">+ çµŒç”±åœ°ã‚’è¿½åŠ </button>
                </div>
            `;
            appContent.innerHTML = html;
        }

        /** 2. ãƒ«ãƒ¼ãƒˆé¸æŠç”»é¢ */
        function renderRoutePage(index) {
            const segment = itinerary.segments[index];
            const start = itinerary.stops[index].location;
            const end = itinerary.stops[index+1].location;
            
            let html = `
                <h2 class="text-xl font-bold mb-4 text-indigo-700">ãƒ«ãƒ¼ãƒˆé¸æŠ: ${start} â†’ ${end}</h2>
                <div class="space-y-3 mb-6">
            `;
            
            if(segment.mockRoutes) {
                segment.mockRoutes.forEach(r => {
                    const isSel = r.id === segment.selectedRoute;
                    html += `
                        <div onclick="selectRoute(${index}, '${r.id}')" class="p-4 border rounded cursor-pointer ${isSel ? 'bg-indigo-50 border-indigo-500 ring-1 ring-indigo-500' : 'bg-white hover:bg-gray-50'}">
                            <div class="flex justify-between font-bold">
                                <span>${r.label} (${r.desc})</span>
                                <span>${r.durationMinutes}åˆ†</span>
                            </div>
                            <div class="text-right text-sm ${r.tolls.length>0?'text-red-500':'text-green-600'}">${r.tolls.length>0?'æœ‰æ–™':'ç„¡æ–™'}</div>
                        </div>
                    `;
                });
            }

            // â˜… åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠ
            html += `<div id="map-area-${index}" class="w-full h-64 bg-gray-200 rounded-lg mt-4 shadow-inner"></div>`;
            
            html += `
                </div>
                <div class="flex justify-end gap-3">
                    <button onclick="renderInputPage(document.getElementById('app-content'))" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">æˆ»ã‚‹</button>
                    <button onclick="renderSummaryPage(document.getElementById('app-content'))" class="px-4 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">æ¬¡ã¸ï¼šæ¦‚è¦ã¸ ğŸš€</button>
                </div>
            `;
            
            document.getElementById('app-content').innerHTML = html;
            initMapDisplay(index, segment.selectedRoute);
        }

        /** 3. æ¦‚è¦ç”»é¢ */
        function renderSummaryPage(appContent) {
            if(!calculateAllSchedule()) return;
            
            const events = [];
            let c = 1;
            itinerary.stops.forEach((stop, i) => {
                const isLast = i === itinerary.stops.length - 1;
                if(i===0) {
                    const gather = addMinutesToISO(stop.departureTime, -itinerary.gatheringMinutes);
                    events.push({idx: c++, text: `${stop.location}ã€€${formatDisplayTime(gather)}ã€€é›†åˆ`});
                    events.push({idx: c++, text: `${stop.location}ã€€${formatDisplayTime(stop.departureTime)}ã€€å‡ºç™º`});
                } else {
                    events.push({idx: c++, text: `${stop.location}ã€€${formatDisplayTime(stop.arrivalTime)}ã€€åˆ°ç€`});
                    if(!isLast) {
                        events.push({idx: c++, text: `${stop.location}ã€€${stop.stayReason}ã€€ï¼ˆæ»åœ¨ ${stop.stayMinutes}åˆ†ï¼‰ ${stop.memo}`});
                        events.push({idx: c++, text: `${stop.location}ã€€${formatDisplayTime(stop.departureTime)}ã€€å‡ºç™º`});
                    }
                }
                if(!isLast) {
                    const seg = itinerary.segments[i];
                    const route = seg.mockRoutes.find(r=>r.id===seg.selectedRoute);
                    const dur = route ? route.durationMinutes : 30;
                    const mode = getTravelModeLabel(seg.travelMode);
                    const tolls = (route && route.tolls.length>0) ? `ã€€æœ‰æ–™é“è·¯æ–™é‡‘ ${route.tolls[0].standard}å††` : '';
                    events.push({idx: c++, text: `${mode}ã€€${dur}åˆ†${tolls}`});
                }
            });

            const rows = events.map(e => `
                <div class="shiori-row">
                    <div class="shiori-num">${e.idx.toString().padStart(2,'0')}.</div>
                    <div class="shiori-content">${e.text}</div>
                </div>
            `).join('');

            appContent.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100 max-w-3xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-center mb-2 text-indigo-900">${itinerary.planName}</h2>
                    <div class="font-mono text-base md:text-lg leading-relaxed">${rows}</div>
                </div>
                <div class="mt-6 flex justify-center gap-4">
                    <button onclick="renderInputPage(document.getElementById('app-content'))" class="px-6 py-3 bg-gray-500 text-white rounded-lg">ä¿®æ­£ã™ã‚‹</button>
                    <button onclick="window.print()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-bold">å°åˆ· / PDFä¿å­˜</button>
                </div>
            `;
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = function() {
            updateDatalist();
            renderInputPage(document.getElementById('app-content'));
        };
    </script>
</body>
</html>
