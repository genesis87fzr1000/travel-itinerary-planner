<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (v11.0)</title>
    
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { 
            position: absolute; left: 15px; top: 10px; bottom: -20px; 
            width: 2px; background-color: #e5e7eb; z-index: 0; 
        }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { 
            position: absolute; left: 0; top: 0; 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; z-index: 10;
        }
        
        /* å°åˆ·ç”¨ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; }
            .shadow-xl, .shadow-md, .border { box-shadow: none !important; border: none !important; }
        }
        .print-only { display: none; }
        
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="bg-gray-50 min-h-screen p-2 sm:p-6 text-gray-800">

    <div id="auth-screen" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">ãƒ†ã‚¹ãƒˆã‚¢ã‚¯ã‚»ã‚¹èªè¨¼</h2>
            <p class="text-gray-600 mb-6">é–¢ä¿‚è€…å°‚ç”¨ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="password" id="password-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="w-full p-3 border-2 border-indigo-200 rounded-lg text-lg mb-4 focus:border-indigo-500" onkeydown="if(event.key==='Enter') attemptLogin()">
            <button onclick="attemptLogin()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">ã‚¢ã‚¯ã‚»ã‚¹</button>
            <p id="auth-error" class="text-red-500 mt-3 hidden text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚</p>
        </div>
    </div>
    <div id="main-app-container" class="hidden"> 
        <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden print:overflow-visible min-h-[800px]">
            <div class="print-only text-center py-4 border-b">
                <h1 class="text-3xl font-extrabold text-gray-800">æ—…ã®ã—ãŠã‚Š</h1>
            </div>

            <header class="p-4 sm:p-6 bg-indigo-700 text-white shadow-md flex justify-between items-center no-print">
                <h1 onclick="navigate('dashboard')" class="text-xl sm:text-2xl font-extrabold flex items-center gap-2 cursor-pointer hover:opacity-80">
                    <span>ğŸ—ºï¸</span> æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ <span class="text-xs bg-indigo-500 px-2 py-1 rounded-full">v11.0</span>
                </h1>
                <div class="flex gap-4 text-xs sm:text-sm">
                    <button onclick="navigate('dashboard')" class="text-indigo-100 hover:text-white font-bold flex items-center gap-1">
                        ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸
                    </button>
                </div>
            </header>

            <nav id="editor-nav" class="hidden flex border-b border-gray-200 bg-gray-50 text-sm font-bold no-print">
                <button onclick="navigate('input')" id="nav-input" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">1. åœ°ç‚¹ãƒ»åŸºç‚¹</button>
                <button onclick="validateAndNavigate('selection')" id="nav-selection" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">2. ãƒ«ãƒ¼ãƒˆé¸æŠ</button>
                <button onclick="validateAndNavigate('shiori')" id="nav-shiori" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">3. æ—…ã®ã—ãŠã‚Š</button>
            </nav>

            <main id="app-content" class="p-4 sm:p-8 animate-fade-in">
                <div class="text-center p-20 text-gray-400">Loading...</div>
            </main>

            <div id="message-container" class="fixed bottom-4 right-4 z-50 no-print"></div>
        </div>
        </div>
    
    <datalist id="saved-locations-list"></datalist>

    <script>
        // --- 0. åˆæœŸåŒ–ã¨èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ (v11.0) ---
        
        // â˜…â˜…â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š: ã€Œ1234ã€ â˜…â˜…â˜…
        const ACCESS_PASSWORD = "1234"; 
        // â˜…â˜…â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã“ã“ã¾ã§ â˜…â˜…â˜…

        function attemptLogin() {
            const input = document.getElementById('password-input').value;
            const error = document.getElementById('auth-error');
            const authScreen = document.getElementById('auth-screen');
            const mainContainer = document.getElementById('main-app-container');

            if (input === ACCESS_PASSWORD) {
                authScreen.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                error.classList.add('hidden');
                // èªè¨¼æˆåŠŸå¾Œã€ã‚¢ãƒ—ãƒªã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
                initializeApp();
            } else {
                error.classList.remove('hidden');
            }
        }
        
        function initMap() { console.log("Maps API Loaded"); }
        const APP_VERSION = '11.0';

        let planList = [];
        let savedLocations = [];
        let currentPlan = null;
        let mapInstances = {};
        
        function initializeApp() {
            // v10.0ã®åˆæœŸåŒ–å‡¦ç†ã‚’ç§»æ¤
            planList = JSON.parse(localStorage.getItem('planList')) || [];
            savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
            currentPlan = null;
            mapInstances = {};
            
            migrateData();
            renderDashboard();
            updateDatalist();
        }

        window.onload = function() {
            // åˆæœŸè¡¨ç¤ºã¯èªè¨¼ç”»é¢ã®ã¿
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app-container').classList.add('hidden');
        }

        // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† (è¤‡æ•°ãƒ—ãƒ©ãƒ³å¯¾å¿œ) ---
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ©ãƒ³ç”Ÿæˆ
        const generateDefaultItinerary = () => ({
            id: 'plan_' + Date.now(),
            version: APP_VERSION,
            planName: "æ–°è¦æ—…ç¨‹ãƒ—ãƒ©ãƒ³",
            updatedAt: new Date().toISOString(),
            baseDateTime: new Date().toISOString().substring(0, 16),
            roundingMinutes: 0,
            gatheringMinutes: 10,
            stops: [
                { id: 's1', name: 'æ±äº¬é§…', location: 'æ±äº¬é§…', isBaseTime: true, stayMinutes: 0, stayReason: '', memo: '' },
                { id: 's2', name: 'æ¸‹è°·é§…', location: 'æ¸‹è°·é§…', isBaseTime: false, stayMinutes: 15, stayReason: 'Bç­åˆæµ', memo: '' },
                { id: 's3', name: 'æ¨ªæµœé§…', location: 'æ¨ªæµœé§…', isBaseTime: false, stayMinutes: 0, stayReason: '', memo: '' }
            ],
            segments: [],
            currentPage: 'input'
        });

        // v9.0ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå‡¦ç†
        function migrateData() {
            const oldState = localStorage.getItem('itineraryState');
            if (oldState && planList.length === 0) {
                try {
                    const parsed = JSON.parse(oldState);
                    parsed.id = 'plan_' + Date.now();
                    parsed.updatedAt = new Date().toISOString();
                    planList.push(parsed);
                    localStorage.setItem('planList', JSON.stringify(planList));
                } catch(e) { console.error("Migration failed", e); }
            }
        }

        // ãƒ—ãƒ©ãƒ³æ“ä½œ
        function createNewPlan() {
            const newPlan = generateDefaultItinerary();
            planList.unshift(newPlan);
            saveAllPlans();
            loadPlan(newPlan.id);
        }

        function loadPlan(id) {
            currentPlan = planList.find(p => p.id === id);
            if (!currentPlan) return;
            navigate('input');
        }

        function deletePlan(id) {
            if(!confirm('ã“ã®ãƒ—ãƒ©ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå¾©å…ƒã¯ã§ãã¾ã›ã‚“ã€‚')) return;
            planList = planList.filter(p => p.id !== id);
            saveAllPlans();
            renderDashboard();
        }

        function duplicatePlan(id) {
            const src = planList.find(p => p.id === id);
            if(!src) return;
            const copy = JSON.parse(JSON.stringify(src));
            copy.id = 'plan_' + Date.now();
            copy.planName += ' (ã‚³ãƒ”ãƒ¼)';
            copy.updatedAt = new Date().toISOString();
            planList.unshift(copy);
            saveAllPlans();
            renderDashboard();
        }

        function saveState() {
            if (!currentPlan) return;
            currentPlan.updatedAt = new Date().toISOString();
            const idx = planList.findIndex(p => p.id === currentPlan.id);
            if (idx !== -1) planList[idx] = currentPlan;
            saveAllPlans();
            updateDatalist();
        }

        function saveAllPlans() {
            localStorage.setItem('planList', JSON.stringify(planList));
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
        }

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & è¨ˆç®— ---
        function addMinutes(iso, m) { const d=new Date(iso); d.setMinutes(d.getMinutes()+m); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function formatTime(iso) { if(!iso) return "--:--"; const d=new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
        function formatDate(iso) { if(!iso) return ""; const d=new Date(iso); return d.toLocaleDateString() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2,'0'); }
        function getModeLabel(m) { const l={'DRIVING':'è»Š','WALKING':'å¾’æ­©','BICYCLING':'è‡ªè»¢è»Š','TRANSIT':'é›»è»Š'}; return l[m]||'è»Š'; }
        function stripHtml(html) { let tmp=document.createElement("DIV"); tmp.innerHTML=html; return tmp.textContent||tmp.innerText||""; }
        function ceilTime(iso, unit) { if(!unit||unit===0) return iso; const d=new Date(iso); const m=d.getMinutes(); const r=m%unit; if(r===0)return iso; d.setMinutes(m+(unit-r)); d.setSeconds(0); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function floorTime(iso, unit) { if(!unit||unit===0) return iso; const d=new Date(iso); const m=d.getMinutes(); const r=m%unit; if(r===0)return iso; d.setMinutes(m-r); d.setSeconds(0); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }

        // --- 3. Google API ---
        function validateLocation(id) {
            const stop = currentPlan.stops.find(s=>s.id===id);
            if(!stop.name) return showAlert('åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');
            showAlert('ä½æ‰€ã‚’ç¢ºå®šä¸­...', 'info');
            new google.maps.places.AutocompleteService().getPlacePredictions({ input: stop.name }, (preds, status) => {
                if (status === 'OK' && preds.length > 0) {
                    stop.location = preds[0].description;
                    saveState(); renderInputPage();
                    showAlert(`âœ… ä½æ‰€ç¢ºå®š: ${stop.name} ã®æ¤œç´¢ç”¨ä½æ‰€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
                } else {
                    // æ¤œè¨¼å¤±æ•—æ™‚ã¯locationã‚’ãƒªã‚»ãƒƒãƒˆã—ã€å†æ¤œè¨¼ã‚’ä¿ƒã™
                    stop.location = ''; 
                    saveState(); renderInputPage();
                    showAlert('é©åˆ‡ãªä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            });
        }
        
        async function fetchRealRoutes(index) {
            showAlert(`åŒºé–“ ${index+1} ã®ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...`, 'info');
            const seg = currentPlan.segments[index];
            const start = currentPlan.stops[index].location;
            const end = currentPlan.stops[index+1].location;
            const mode = seg.travelMode || 'DRIVING';
            const depTime = new Date(currentPlan.baseDateTime);

            return new Promise((resolve) => {
                const ds = new google.maps.DirectionsService();
                ds.route({
                    origin: start, destination: end, travelMode: mode, 
                    drivingOptions: mode==='DRIVING' ? { departureTime: depTime } : undefined,
                    provideRouteAlternatives: true
                }, (res, status) => {
                    if (status === 'OK') {
                        seg.mockRoutes = res.routes.slice(0,3).map((r, i) => {
