<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ (v12.0)</title>
    
    <meta name="robots" content="noindex, nofollow">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeline-container { position: relative; padding-left: 2rem; }
        .timeline-line { 
            position: absolute; left: 15px; top: 10px; bottom: -20px; 
            width: 2px; background-color: #e5e7eb; z-index: 0; 
        }
        .timeline-item:last-child .timeline-line { display: none; }
        .timeline-dot { 
            position: absolute; left: 0; top: 0; 
            width: 32px; height: 32px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; z-index: 10;
        }
        
        /* å°åˆ·ç”¨ */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; padding: 0; }
            .shadow-xl, .shadow-md, .border { box-shadow: none !important; border: none !important; }
        }
        .print-only { display: none; }
        
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .card-hover { transition: all 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOStiNglNEGEnPnhDxJG0RSQqgJXVtUQw&libraries=places,geometry&callback=initMap" async defer></script>
</head>
<body class="bg-gray-50 min-h-screen p-2 sm:p-6 text-gray-800">

    <div class="max-w-5xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden print:overflow-visible min-h-[800px]">
        <div class="print-only text-center py-4 border-b">
            <h1 class="text-3xl font-extrabold text-gray-800">æ—…ã®ã—ãŠã‚Š</h1>
        </div>

        <header class="p-4 sm:p-6 bg-indigo-700 text-white shadow-md flex justify-between items-center no-print">
            <h1 onclick="navigate('dashboard')" class="text-xl sm:text-2xl font-extrabold flex items-center gap-2 cursor-pointer hover:opacity-80">
                <span>ğŸ—ºï¸</span> æ—…ç¨‹ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ <span class="text-xs bg-indigo-500 px-2 py-1 rounded-full">v12.0</span>
            </h1>
            <div class="flex gap-2 sm:gap-4 text-xs sm:text-sm items-center">
                <a id="feedback-link" href="#" target="_blank" class="bg-white text-indigo-700 px-3 py-1 rounded-full font-bold hover:bg-gray-100 transition flex items-center gap-1">
                    ğŸ’¬ <span class="hidden sm:inline">ã”æ„è¦‹ãƒ»ã”æ„Ÿæƒ³</span>
                </a>
                <div class="h-6 w-px bg-indigo-400 mx-1"></div>
                <button onclick="navigate('dashboard')" class="text-indigo-100 hover:text-white font-bold flex items-center gap-1">
                    ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸
                </button>
            </div>
        </header>

        <nav id="editor-nav" class="hidden flex border-b border-gray-200 bg-gray-50 text-sm font-bold no-print">
            <button onclick="navigate('input')" id="nav-input" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">1. åœ°ç‚¹ãƒ»åŸºç‚¹</button>
            <button onclick="validateAndNavigate('selection')" id="nav-selection" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">2. ãƒ«ãƒ¼ãƒˆé¸æŠ</button>
            <button onclick="validateAndNavigate('shiori')" id="nav-shiori" class="flex-1 py-4 text-gray-500 hover:text-indigo-600 border-b-4 border-transparent">3. æ—…ã®ã—ãŠã‚Š</button>
        </nav>

        <main id="app-content" class="p-4 sm:p-8 animate-fade-in">
            <div class="text-center p-20 text-gray-400">Loading...</div>
        </main>

        <div id="message-container" class="fixed bottom-4 right-4 z-50 no-print"></div>
    </div>
    <datalist id="saved-locations-list"></datalist>

    <script>
        // --- 0. åˆæœŸåŒ–è¨­å®š ---
        
        // â˜…â˜…â˜… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨URL (Googleãƒ•ã‚©ãƒ¼ãƒ ç­‰ã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„) â˜…â˜…â˜…
        const FEEDBACK_URL = "https://forms.gle/xqzpM5jmdgSMeZSB9"; 
        // â˜…â˜…â˜… æ›¸ãæ›ãˆã“ã“ã¾ã§ â˜…â˜…â˜…

        function initMap() { console.log("Maps API Loaded"); }
        const APP_VERSION = '12.0';

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.onload = function() {
            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªãƒ³ã‚¯ã®è¨­å®š
            const fbLink = document.getElementById('feedback-link');
            if(fbLink) fbLink.href = FEEDBACK_URL;

            // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã¨åˆæœŸè¡¨ç¤º
            migrateData();
            renderDashboard();
            updateDatalist();
        }

        // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let planList = JSON.parse(localStorage.getItem('planList')) || [];
        let savedLocations = JSON.parse(localStorage.getItem('savedLocations')) || [];
        let currentPlan = null;
        let mapInstances = {};

        const generateDefaultItinerary = () => ({
            id: 'plan_' + Date.now(),
            version: APP_VERSION,
            planName: "æ–°è¦æ—…ç¨‹ãƒ—ãƒ©ãƒ³",
            updatedAt: new Date().toISOString(),
            baseDateTime: new Date().toISOString().substring(0, 16),
            roundingMinutes: 0,
            gatheringMinutes: 10,
            stops: [
                { id: 's1', name: 'æ±äº¬é§…', location: 'æ±äº¬é§…', isBaseTime: true, stayMinutes: 0, stayReason: '', memo: '' },
                { id: 's2', name: 'æ¸‹è°·é§…', location: 'æ¸‹è°·é§…', isBaseTime: false, stayMinutes: 15, stayReason: 'Bç­åˆæµ', memo: '' },
                { id: 's3', name: 'æ¨ªæµœé§…', location: 'æ¨ªæµœé§…', isBaseTime: false, stayMinutes: 0, stayReason: '', memo: '' }
            ],
            segments: [],
            currentPage: 'input'
        });

        function migrateData() {
            const oldState = localStorage.getItem('itineraryState');
            if (oldState && planList.length === 0) {
                try {
                    const parsed = JSON.parse(oldState);
                    parsed.id = 'plan_' + Date.now();
                    parsed.updatedAt = new Date().toISOString();
                    planList.push(parsed);
                    localStorage.setItem('planList', JSON.stringify(planList));
                } catch(e) {}
            }
        }

        function createNewPlan() {
            const newPlan = generateDefaultItinerary();
            planList.unshift(newPlan);
            saveAllPlans();
            loadPlan(newPlan.id);
        }

        function loadPlan(id) {
            currentPlan = planList.find(p => p.id === id);
            if (!currentPlan) return;
            navigate('input');
        }

        function deletePlan(id) {
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            planList = planList.filter(p => p.id !== id);
            saveAllPlans();
            renderDashboard();
        }

        function duplicatePlan(id) {
            const src = planList.find(p => p.id === id);
            if(!src) return;
            const copy = JSON.parse(JSON.stringify(src));
            copy.id = 'plan_' + Date.now();
            copy.planName += ' (ã‚³ãƒ”ãƒ¼)';
            copy.updatedAt = new Date().toISOString();
            planList.unshift(copy);
            saveAllPlans();
            renderDashboard();
        }

        function saveState() {
            if (!currentPlan) return;
            currentPlan.updatedAt = new Date().toISOString();
            const idx = planList.findIndex(p => p.id === currentPlan.id);
            if (idx !== -1) planList[idx] = currentPlan;
            saveAllPlans();
            updateDatalist();
        }

        function saveAllPlans() {
            localStorage.setItem('planList', JSON.stringify(planList));
            localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
        }

        // --- 2. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function addMinutes(iso, m) { const d=new Date(iso); d.setMinutes(d.getMinutes()+m); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function formatTime(iso) { if(!iso) return "--:--"; const d=new Date(iso); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }
        function formatDate(iso) { if(!iso) return ""; const d=new Date(iso); return d.toLocaleDateString(); }
        function getModeLabel(m) { const l={'DRIVING':'è»Š','WALKING':'å¾’æ­©','BICYCLING':'è‡ªè»¢è»Š','TRANSIT':'é›»è»Š'}; return l[m]||'è»Š'; }
        function stripHtml(html) { let tmp=document.createElement("DIV"); tmp.innerHTML=html; return tmp.textContent||tmp.innerText||""; }
        function ceilTime(iso, unit) { if(!unit||unit===0) return iso; const d=new Date(iso); const m=d.getMinutes(); const r=m%unit; if(r===0)return iso; d.setMinutes(m+(unit-r)); d.setSeconds(0); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }
        function floorTime(iso, unit) { if(!unit||unit===0) return iso; const d=new Date(iso); const m=d.getMinutes(); const r=m%unit; if(r===0)return iso; d.setMinutes(m-r); d.setSeconds(0); const tz=d.getTimezoneOffset()*60000; return (new Date(d-tz)).toISOString().slice(0,16); }

        // --- 3. Google API ---
        function validateLocation(id) {
            const stop = currentPlan.stops.find(s=>s.id===id);
            if(!stop.name) return showAlert('åœ°ç‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');
            showAlert('ä½æ‰€ã‚’ç¢ºå®šä¸­...', 'info');
            new google.maps.places.AutocompleteService().getPlacePredictions({ input: stop.name }, (preds, status) => {
                if (status === 'OK' && preds.length > 0) {
                    stop.location = preds[0].description;
                    saveState(); renderInputPage();
                    showAlert(`âœ… ä½æ‰€ç¢ºå®š: ${stop.name}`, 'success');
                } else {
                    stop.location = ''; 
                    saveState(); renderInputPage();
                    showAlert('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                }
            });
        }
        
        async function fetchRealRoutes(index) {
            const seg = currentPlan.segments[index];
            const start = currentPlan.stops[index].location;
            const end = currentPlan.stops[index+1].location;
            const mode = seg.travelMode || 'DRIVING';
            const depTime = new Date(currentPlan.baseDateTime);

            return new Promise((resolve) => {
                const ds = new google.maps.DirectionsService();
                ds.route({
                    origin: start, destination: end, travelMode: mode, 
                    drivingOptions: mode==='DRIVING' ? { departureTime: depTime } : undefined,
                    provideRouteAlternatives: true
                }, (res, status) => {
                    if (status === 'OK') {
                        seg.mockRoutes = res.routes.slice(0,3).map((r, i) => {
                            let roadNames = new Set();
                            r.legs[0].steps.forEach(step => {
                                const txt = stripHtml(step.instructions);
                                if(txt.includes('æœ‰æ–™') || txt.includes('é«˜é€Ÿ') || txt.includes('è‡ªå‹•è»Šé“') || txt.includes('ã‚¹ã‚«ã‚¤ãƒ©ã‚¤ãƒ³') || txt.includes('æ–™é‡‘æ‰€')) {
                                    const match = txt.match(/([^\sã€Œã€]+(?:é«˜é€Ÿ|è‡ªå‹•è»Šé“|ãƒ©ã‚¤ãƒ³|ã‚¹ã‚«ã‚¤ã‚¦ã‚§ã‚¤|é“è·¯)[^\s]*)/);
                                    if(match) roadNames.add(match[1]);
                                }
                            });
                            if(mode==='DRIVING' && roadNames.size === 0 && (r.summary.includes('é«˜é€Ÿ') || r.summary.includes('æœ‰æ–™'))) roadNames.add(r.summary);
                            return {
                                id: `r-${index}-${i}`, label: r.summary, durationMinutes: Math.ceil(r.legs[0].duration.value / 60),
                                desc: stripHtml(r.summary), roads: Array.from(roadNames), overview_path: r.overview_path
                            };
                        });
                        if(!seg.selectedRoute) seg.selectedRoute = seg.mockRoutes[0].id;
                        resolve(true);
                    } else {
                        seg.mockRoutes = [];
                        resolve(false);
                    }
                });
            });
        }

        // --- 4. ç”»é¢æç”» ---
        function navigate(page) {
            const nav = document.getElementById('editor-nav');
            if (page === 'dashboard') {
                currentPlan = null;
                nav.classList.add('hidden');
                renderDashboard();
                return;
            }
            if (!currentPlan) return navigate('dashboard');
            
            currentPlan.currentPage = page;
            nav.classList.remove('hidden');
            document.querySelectorAll('#nav-input, #nav-selection, #nav-shiori').forEach(el => {
                el.classList.remove('text-indigo-600', 'border-indigo-600');
                el.classList.add('text-gray-500', 'border-transparent');
            });
            const active = document.getElementById(`nav-${page}`);
            if(active) {
                active.classList.remove('text-gray-500', 'border-transparent');
                active.classList.add('text-indigo-600', 'border-indigo-600');
            }

            if(page === 'input') renderInputPage();
            else if(page === 'selection') renderSelectionPage();
            else if(page === 'shiori') renderSummaryPage();
        }

        function validateAndNavigate(targetPage) {
            if (targetPage !== 'input' && currentPlan.currentPage !== 'input') return navigate(targetPage);
            const unvalidatedStops = currentPlan.stops.filter(s => !s.location || s.location.trim() === '');
            if (unvalidatedStops.length > 0) {
                const names = unvalidatedStops.map(s => s.name || 'åœ°ç‚¹');
                showAlert(`âš ï¸ ã€${names.join(', ')}ã€‘ã®ä½æ‰€ãŒæœªç¢ºå®šã§ã™ã€‚\nå„åœ°ç‚¹ã®ã€Œä½æ‰€ç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'error');
                if (targetPage !== 'input') navigate('input');
                return;
            }
            navigate(targetPage);
        }

        // â–  0. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
        function renderDashboard() {
            const el = document.getElementById('app-content');
            let plansHtml = '';
            if (planList.length === 0) {
                plansHtml = `<div class="text-center py-10 text-gray-500">ã¾ã ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œæ–°è¦ä½œæˆã€ãƒœã‚¿ãƒ³ã‹ã‚‰æ—…ã®è¨ˆç”»ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>`;
            } else {
                plansHtml = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                planList.forEach(p => {
                    const placeCount = p.stops.length;
                    plansHtml += `
                        <div class="bg-white p-6 rounded-xl shadow border border-gray-100 card-hover flex flex-col justify-between h-full">
                            <div>
                                <h3 class="font-bold text-xl text-indigo-800 mb-2 truncate">${p.planName || 'ç„¡é¡Œã®ãƒ—ãƒ©ãƒ³'}</h3>
                                <p class="text-xs text-gray-400 mb-4">æ›´æ–°: ${formatDate(p.updatedAt)}</p>
                                <div class="text-sm text-gray-600 mb-4 bg-gray-50 p-2 rounded">
                                    ğŸ“ ${placeCount}ç®‡æ‰€ / ğŸ“… ${formatDate(p.baseDateTime)}
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 border-t pt-4">
                                <div class="flex gap-2">
                                    <button onclick="duplicatePlan('${p.id}')" class="text-xs text-gray-400 hover:text-indigo-600">è¤‡è£½</button>
                                    <button onclick="deletePlan('${p.id}')" class="text-xs text-red-300 hover:text-red-500">å‰Šé™¤</button>
                                </div>
                                <button onclick="loadPlan('${p.id}')" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow hover:bg-indigo-700">é–‹ã ğŸš€</button>
                            </div>
                        </div>
                    `;
                });
                plansHtml += `</div>`;
            }

            let locHtml = '';
            if (savedLocations.length === 0) {
                locHtml = '<p class="text-sm text-gray-400">ä¿å­˜ã•ã‚ŒãŸåœ°ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            } else {
                locHtml = `<div class="flex flex-wrap gap-2">`;
                savedLocations.forEach((loc, i) => {
                    locHtml += `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-gray-100 text-gray-700">
                        ${loc} <button onclick="removeSavedLocation(${i})" class="ml-2 text-gray-400 hover:text-red-500 font-bold">Ã—</button>
                    </span>`;
                });
                locHtml += `</div>`;
            }

            el.innerHTML = `
                <div class="space-y-12">
                    <div class="text-center">
                         <h2 class="text-3xl font-extrabold text-gray-800 mb-2">ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
                         <button onclick="createNewPlan()" class="mt-4 px-8 py-4 bg-gradient-brand text-white text-xl font-bold rounded-full shadow-xl hover:opacity-90 transition">
                            + æ–°ã—ã„æ—…ç¨‹ã‚’ä½œæˆã™ã‚‹
                         </button>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-3">ğŸ“‚ ä¿å­˜æ¸ˆã¿ãƒ—ãƒ©ãƒ³</h3>
                        ${plansHtml}
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“– ä¿å­˜æ¸ˆã¿åœ°ç‚¹ (${savedLocations.length}ä»¶)</h3>
                        ${locHtml}
                    </div>
                </div>
            `;
        }

        // â–  1. å…¥åŠ›ç”»é¢
        function renderInputPage() {
            while(currentPlan.segments.length < currentPlan.stops.length - 1) currentPlan.segments.push({ travelMode: 'DRIVING', mockRoutes: [], selectedRoute: null });

            let h = `
                <div class="space-y-6">
                    <div class="bg-indigo-700 p-4 rounded-xl shadow-lg -mt-2 mb-4">
                        <label class="block text-xs font-bold text-indigo-200 mb-1">ãƒ—ãƒ©ãƒ³å</label>
                        <input type="text" value="${currentPlan.planName}" onchange="currentPlan.planName=this.value;saveState();" class="w-full p-2 rounded text-lg font-bold text-gray-800" placeholder="ãƒ—ãƒ©ãƒ³åã‚’å…¥åŠ›">
                    </div>
                    <div class="p-5 bg-white rounded-xl shadow-sm border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">åŸºç‚¹æ—¥æ™‚</label><input type="datetime-local" value="${currentPlan.baseDateTime}" onchange="currentPlan.baseDateTime=this.value;saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold"></div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ™‚é–“ä¸¸ã‚</label>
                            <select onchange="updateRounding(this.value)" class="w-full p-2 border rounded bg-gray-50 font-bold">
                                <option value="0" ${currentPlan.roundingMinutes===0?'selected':''}>ãªã—</option>
                                <option value="5" ${currentPlan.roundingMinutes===5?'selected':''}>5åˆ†å˜ä½</option>
                                <option value="10" ${currentPlan.roundingMinutes===10?'selected':''}>10åˆ†å˜ä½</option>
                            </select>
                        </div>
                        <div><label class="text-xs font-bold text-gray-500">é›†åˆæ™‚é–“</label><select onchange="currentPlan.gatheringMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded bg-gray-50 font-bold">${[5,10,15,20,30,45,60].map(m=>`<option value="${m}" ${currentPlan.gatheringMinutes===m?'selected':''}>${m}åˆ†å‰</option>`).join('')}</select></div>
                    </div>
                    <div class="space-y-4">`;

            currentPlan.stops.forEach((s, i) => {
                const isFirst=i===0, isLast=i===currentPlan.stops.length-1;
                const moveUp = !isFirst ? `<button onclick="moveStop(${i}, -1)" class="text-gray-400 hover:text-indigo-600 px-1">â†‘</button>` : '';
                const moveDown = !isLast ? `<button onclick="moveStop(${i}, 1)" class="text-gray-400 hover:text-indigo-600 px-1">â†“</button>` : '';
                const isValidated = s.location && s.location.trim() !== '';
                const btnColor = isValidated ? 'bg-green-50 text-green-600' : 'bg-indigo-50 text-indigo-600';
                const validationStatus = isValidated ? `<p class="text-xs font-bold text-amber-600 mt-1">â€»Googleæ¤œç´¢ç”¨: ${s.location}</p>` : `<p class="text-xs font-bold text-red-500 mt-1">â€»ã€Œä½æ‰€ç¢ºå®šã€ãŒå¿…è¦ã§ã™</p>`;

                h += `
                    <div class="bg-white p-5 rounded-xl border ${s.isBaseTime ? 'border-red-500 ring-2 ring-red-100' : 'border-gray-200'} shadow-sm relative">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg text-gray-800 flex items-center">
                                ${i+1}. ${s.name || 'åœ°ç‚¹'} ${isFirst?'å‡ºç™º':isLast?'åˆ°ç€':'çµŒç”±'}
                                ${s.isBaseTime?'<span class="text-xs bg-red-100 text-red-700 px-2 rounded ml-2 font-bold">â˜… åŸºç‚¹</span>':''}
                            </h3>
                            <div class="flex items-center gap-3">
                                <div class="flex border rounded bg-gray-50">${moveUp}${moveDown}</div>
                                ${(!isFirst && !isLast)?`<button onclick="removeStop(${i})" class="text-red-400 text-sm hover:text-red-600">å‰Šé™¤</button>`:''}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="text-xs font-bold text-gray-400">åœ°ç‚¹å</label>
                            <div class="flex gap-2">
                                <input type="text" list="saved-locations-list" value="${s.name}" onchange="updateName(${i}, this.value)" class="flex-1 p-2 border rounded font-bold text-lg" placeholder="ä¾‹: æ±äº¬é§…">
                                <button onclick="validateLocation('${s.id}')" class="flex-shrink-0 ${btnColor} px-4 rounded font-bold hover:opacity-80">âœ… ä½æ‰€ç¢ºå®š</button>
                                <button onclick="saveLoc('${s.id}')" class="bg-gray-100 px-3 rounded text-gray-500">ğŸ’¾</button>
                            </div>
                            ${validationStatus}
                        </div>
                        ${(!isFirst && !isLast) ? `
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨æ™‚é–“ (åˆ†)</label><input type="number" value="${s.stayMinutes}" onchange="currentPlan.stops[${i}].stayMinutes=parseInt(this.value);saveState();" class="w-full p-2 border rounded text-center font-bold"></div>
                            <div><label class="text-xs font-bold text-gray-400">æ»åœ¨ç†ç”±</label><input type="text" value="${s.stayReason}" onchange="currentPlan.stops[${i}].stayReason=this.value;saveState();" class="w-full p-2 border rounded"></div>
                        </div>` : ''}
                        <div class="mb-3"><label class="text-xs font-bold text-gray-400">ãƒ¡ãƒ¢</label><input type="text" value="${s.memo}" onchange="currentPlan.stops[${i}].memo=this.value;saveState();" class="w-full p-2 border rounded bg-yellow-50 placeholder-yellow-200" placeholder="ä¾‹: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³äºˆç´„æ¸ˆã¿"></div>
                        <div class="flex items-center gap-2 pt-2 border-t border-gray-100">
                            <input type="radio" name="base" ${s.isBaseTime?'checked':''} onchange="setBase(${i})" class="text-red-600 accent-red-600">
                            <span class="text-sm font-bold ${s.isBaseTime?'text-red-600':'text-gray-500'}">ã“ã®æ™‚é–“ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºç‚¹ã«ã™ã‚‹</span>
                        </div>
                        ${!isLast ? `
                        <div class="mt-4 pt-3 bg-gray-50 -mx-5 -mb-5 px-5 pb-4 border-t border-gray-100">
                            <div class="flex items-center gap-3">
                                <p class="text-xs text-gray-400 font-bold">â–¼ ç§»å‹•æ‰‹æ®µ:</p>
                                <div class="flex gap-1">
                                    ${['DRIVING','WALKING','BICYCLING'].map(m => `
                                        <button onclick="changeMode(${i}, '${m}')" class="px-3 py-1 rounded text-sm font-bold transition-all ${currentPlan.segments[i]?.travelMode===m ? 'bg-indigo-600 text-white shadow' : 'bg-white border text-gray-500'}">${getModeLabel(m)}</button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>` : ''}
                    </div>`;
            });

            h += `</div>
                  <button onclick="addStop()" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 text-gray-500 font-bold rounded-xl hover:border-indigo-500 hover:text-indigo-500 transition">+ åœ°ç‚¹ã‚’è¿½åŠ </button>
                  <div class="h-10"></div>
                  <button onclick="validateAndNavigate('selection')" class="w-full py-5 bg-gradient-brand text-white font-extrabold text-xl rounded-2xl shadow-xl hover:opacity-90 transition transform hover:-translate-y-1">æ¬¡ã¸ï¼šãƒ«ãƒ¼ãƒˆé¸æŠ ğŸš€</button>
                </div>`;
            document.getElementById('app-content').innerHTML = h;
        }

        // â–  2. ãƒ«ãƒ¼ãƒˆé¸æŠç”»é¢
        async function renderSelectionPage() {
            const el = document.getElementById('app-content');
            el.innerHTML = '<div class="text-center p-20"><div class="text-2xl font-bold text-indigo-600 mb-2">ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...</div><p class="text-gray-500">Google Maps APIã¨é€šä¿¡ã—ã¦ã„ã¾ã™</p></div>';

            for(let i=0; i<currentPlan.segments.length; i++) {
                if(currentPlan.stops[i].location && currentPlan.stops[i+1].location) await fetchRealRoutes(i);
            }
            saveState();

            let h = `<h2 class="text-xl font-bold mb-6 text-gray-800">2. ãƒ«ãƒ¼ãƒˆç¢ºèª</h2><div class="space-y-8">`;
            currentPlan.segments.forEach((seg, i) => {
                const startName = currentPlan.stops[i].name;
                const endName = currentPlan.stops[i+1].name;
                h += `<div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                        <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center"><span class="font-bold text-gray-700">åŒºé–“ ${i+1}: ${startName} â†’ ${endName} (${getModeLabel(seg.travelMode)})</span></div>
                        <div class="p-4">`;
                if(!seg.mockRoutes || seg.mockRoutes.length===0) {
                    h += `<p class="text-red-500">ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>`;
                } else {
                    h += `<div class="space-y-3 mb-4">`;
                    seg.mockRoutes.forEach(r => {
                        const isSel = r.id === seg.selectedRoute;
                        let roadsHtml = '';
                        if(r.roads.length > 0) roadsHtml = `<div class="mt-2 text-xs text-gray-600 bg-gray-50 p-3 rounded border border-gray-200"><p class="font-bold mb-1 text-gray-500">æœ‰æ–™åŒºé–“ã‚ã‚Š:</p>${r.roads.map((name, idx) => `<div>${['â‘ ','â‘¡','â‘¢','â‘£','â‘¤'][idx]||'ãƒ»'} ${name}</div>`).join('')}</div>`;
                        else if (seg.travelMode === 'DRIVING') roadsHtml = `<div class="mt-2 text-xs text-green-600 font-bold pl-2">ç„¡æ–™åŒºé–“ / ä¸‹é“</div>`;
                        
                        h += `<div onclick="selectRoute(${i}, '${r.id}')" class="p-4 border-2 rounded-lg cursor-pointer transition-all ${isSel ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100 hover:border-indigo-300'}">
                                <div class="flex justify-between items-start"><div class="flex-1"><div class="font-bold text-lg text-gray-800">${r.label}</div><div class="text-sm text-gray-500">${r.durationMinutes}åˆ†</div>${roadsHtml}</div>${isSel ? '<span class="bg-indigo-600 text-white px-3 py-1 rounded-full text-xs font-bold">é¸æŠä¸­</span>' : ''}</div>
                              </div>`;
                    });
                    h += `</div><div id="map-area-${i}" class="w-full h-64 bg-gray-200 rounded-lg"></div>`;
                }
                h += `</div></div>`;
            });
            h += `</div><div class="mt-10 flex gap-4"><button onclick="navigate('input')" class="flex-1 py-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300">æˆ»ã‚‹</button><button onclick="validateAndNavigate('shiori')" class="flex-[2] py-4 bg-gradient-brand text-white font-bold text-xl rounded-xl shadow-xl hover:opacity-90">æ—…ã®ã—ãŠã‚Šã‚’ä½œæˆ âœ¨</button></div>`;
            el.innerHTML = h;
            currentPlan.segments.forEach((seg, i) => { if(seg.mockRoutes.length>0) drawMap(i, seg.selectedRoute); });
        }
        
        // â–  3. ã—ãŠã‚Šç”»é¢
        function renderSummaryPage() {
            if(!calculateAllSchedule()) {
                showAlert('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨ˆç®—ã‚¨ãƒ©ãƒ¼: åŸºç‚¹æ—¥æ™‚ã¾ãŸã¯åœ°ç‚¹æƒ…å ±ãŒä¸æ­£ã§ã™ã€‚', 'error');
                return navigate('input');
            }
            let list = []; let c=1;
            const baseDate = new Date(currentPlan.baseDateTime).toLocaleDateString('ja-JP', {year:'numeric', month:'long', day:'numeric'});

            currentPlan.stops.forEach((s, i) => {
                const isLast = i===currentPlan.stops.length-1;
                if(i===0) {
                    const gatherTime = addMinutes(s.departureTime, -currentPlan.gatheringMinutes);
                    list.push({ type:'point', idx:c++, time:formatTime(gatherTime), title:`${s.name} é›†åˆ`, sub:'', highlight:true });
                    list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                } else {
                    list.push({ type:'point', idx:c++, time:formatTime(s.arrivalTime), title:`${s.name} åˆ°ç€`, sub:'', highlight:true });
                    if(!isLast) {
                        const reasonTitle = s.stayReason || 'æ»åœ¨';
                        const stayInfo = `<span class="text-lg font-bold text-gray-800">${reasonTitle}</span> <span class="text-sm font-bold text-gray-500 ml-2">æ»åœ¨ ${s.stayMinutes}åˆ†</span>`;
                        const memoHtml = s.memo ? `<div class="mt-1 text-sm text-gray-600">${s.memo}</div>` : '';
                        list.push({ type:'stay', idx:c++, time:'', titleHtml: stayInfo, sub:memoHtml, highlight:false });
                        list.push({ type:'point', idx:c++, time:formatTime(s.departureTime), title:`${s.name} å‡ºç™º`, sub:'', highlight:false });
                    }
                }
                if(!isLast) {
                    const seg = currentPlan.segments[i];
                    const r = seg.mockRoutes.find(x=>x.id===seg.selectedRoute) || {durationMinutes:30, roads:[]};
                    let roadHtml = '';
                    if(r.roads.length > 0) {
                        roadHtml = `<div class="mt-1 text-xs text-gray-500 font-bold">æœ‰æ–™åŒºé–“ã‚ã‚Š</div>`;
                        r.roads.forEach((name, idx) => { roadHtml += `<div class="text-xs text-gray-600 ml-1">${['â‘ ','â‘¡','â‘¢'][idx]||'ãƒ»'} ${name}</div>`; });
                    }
                    const navUrl = `https://www.google.com/maps/dir/${encodeURIComponent(currentPlan.stops[i].location)}/${encodeURIComponent(currentPlan.stops[i+1].location)}/data=${seg.travelMode==='DRIVING'?'!4m2!4m1!3e0!3e1':''}`; 
                    list.push({ type: 'move', idx: c++, time: `<span class="text-xs text-gray-400">${r.durationMinutes}åˆ†</span>`, title: `${getModeLabel(seg.travelMode)}ç§»å‹•`, sub: `${roadHtml} <div class="mt-2"><a href="${navUrl}" target="_blank" class="no-print inline-flex items-center gap-1 bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold hover:bg-blue-100">ğŸ§­ Google Mapsã§é–‹ã</a></div>` });
                }
            });
            const rows = list.map(item => {
                const dotClass = item.type==='point' && item.highlight ? 'bg-indigo-600 text-white shadow-lg scale-110' : 'bg-white border-2 border-indigo-200 text-indigo-600';
                let timeClass = "w-16 flex-shrink-0 text-right mr-4 font-bold text-lg text-indigo-900";
                if(item.type==='stay' || item.type==='move') timeClass = "w-16 flex-shrink-0 text-right mr-4 text-sm pt-1";
                const titleHtml = item.titleHtml ? item.titleHtml : `<div class="font-bold text-lg text-gray-800">${item.title}</div>`;
                return `<div class="timeline-item flex mb-6 relative pl-6"><div class="timeline-line"></div><div class="timeline-dot ${dotClass} shadow-sm">${item.type==='point' ? 'ğŸ“' : item.type==='move' ? 'ğŸš—' : 'â³'}</div><div class="ml-8 flex-1"><div class="flex flex-row items-baseline"><div class="${timeClass}">${item.time}</div><div class="flex-1">${titleHtml}<div class="mt-1">${item.sub}</div></div></div></div></div>`;
            }).join('');
            document.getElementById('app-content').innerHTML = `<div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-100 max-w-3xl mx-auto print:shadow-none print:border-none"><div class="text-center mb-10 border-b pb-6"><div class="text-sm font-bold text-gray-400 mb-1">æ—…ã®ã—ãŠã‚Šï¼ˆ${baseDate}ï¼‰</div><h2 class="text-3xl font-extrabold text-indigo-900 mb-2">${currentPlan.planName}</h2><div class="text-gray-500 text-sm">ä½œæˆæ—¥: ${new Date().toLocaleDateString()}</div></div><div class="timeline-container">${rows}</div><div class="mt-10 pt-6 border-t border-gray-200 page-break-inside-avoid"><h3 class="font-bold text-gray-700 mb-4 text-center">ğŸ—ºï¸ å…¨è¡Œç¨‹ãƒ«ãƒ¼ãƒˆãƒãƒƒãƒ—</h3><div id="full-map-area" class="w-full h-80 bg-gray-100 rounded-xl shadow-inner print:h-96"></div></div></div><div class="mt-8 flex justify-center gap-4 no-print"><button onclick="validateAndNavigate('selection')" class="bg-gray-500 text-white px-8 py-3 rounded-full font-bold shadow hover:bg-gray-600">ä¿®æ­£ã™ã‚‹</button> <button onclick="window.print()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-indigo-700">å°åˆ· / PDFä¿å­˜ ğŸ–¨ï¸</button></div>`;
            setTimeout(initFullMap, 500);
        }

        // --- 5. åœ°å›³æç”»ãƒ»è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function initFullMap() {
            const div = document.getElementById('full-map-area'); if(!div) return;
            const map = new google.maps.Map(div, {zoom: 8, center: {lat:35.681, lng:139.767}, disableDefaultUI: true});
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: false, polylineOptions:{strokeColor:'#4f46e5', strokeWeight:4} });
            const waypoints = currentPlan.stops.slice(1, currentPlan.stops.length-1).map(s => ({ location: s.location, stopover: true }));
            new google.maps.DirectionsService().route({ origin: currentPlan.stops[0].location, destination: currentPlan.stops[currentPlan.stops.length-1].location, waypoints: waypoints, travelMode: 'DRIVING' }, (res, status) => { if(status==='OK') renderer.setDirections(res); });
        }
        function drawMap(index, routeId) {
            const div = document.getElementById(`map-area-${index}`); if(!div) return; div.innerHTML = '';
            const seg = currentPlan.segments[index]; const rData = seg.mockRoutes.find(r=>r.id===routeId); if(!rData) return;
            const map = new google.maps.Map(div, { zoom: 10, center: {lat:35.681, lng:139.767}, disableDefaultUI:true });
            const polyOpts = { strokeColor: '#4f46e5', strokeWeight: 5, strokeOpacity: seg.travelMode === 'WALKING' ? 0 : 1.0, icons: seg.travelMode === 'WALKING' ? [{ icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 4 }, offset: '0', repeat: '20px' }] : undefined };
            const renderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers:false, polylineOptions: polyOpts });
            new google.maps.DirectionsService().route({ origin: currentPlan.stops[index].location, destination: currentPlan.stops[index+1].location, travelMode: seg.travelMode, provideRouteAlternatives: true }, (res, status) => { if(status==='OK') { const target = res.routes.find(r => r.overview_path.length === rData.overview_path.length) || res.routes[0]; renderer.setDirections({routes:[target], request:res.request}); } });
        }
        function calculateAllSchedule() {
            const baseIdx = currentPlan.stops.findIndex(s=>s.isBaseTime); if(baseIdx===-1) return false;
            const roundUnit = currentPlan.roundingMinutes || 0; let t = currentPlan.baseDateTime;
            for(let i=baseIdx; i<currentPlan.stops.length; i++){ currentPlan.stops[i].arrivalTime = t; const dep = addMinutes(t, currentPlan.stops[i].stayMinutes); currentPlan.stops[i].departureTime = ceilTime(dep, roundUnit); if(i < currentPlan.segments.length) { const seg=currentPlan.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute); t = addMinutes(currentPlan.stops[i].departureTime, r?r.durationMinutes:30); } }
            t = currentPlan.stops[baseIdx].arrivalTime; for(let i=baseIdx-1; i>=0; i--){ const seg=currentPlan.segments[i], r=seg.mockRoutes.find(x=>x.id===seg.selectedRoute); const dur = r?r.durationMinutes:30; const rawDep = addMinutes(currentPlan.stops[i+1].arrivalTime, -dur); currentPlan.stops[i].departureTime = floorTime(rawDep, roundUnit); currentPlan.stops[i].arrivalTime = addMinutes(currentPlan.stops[i].departureTime, -currentPlan.stops[i].stayMinutes); } return true;
        }

        // --- 6. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        function updateName(i, v) { currentPlan.stops[i].name = v; currentPlan.stops[i].location=''; saveState(); } 
        function updateRounding(v) { currentPlan.roundingMinutes = parseInt(v); saveState(); }
        function selectRoute(i, rid) { currentPlan.segments[i].selectedRoute = rid; saveState(); renderSelectionPage(); }
        function moveStop(i, dir) { if(dir===-1&&i===0)return; if(dir===1&&i===currentPlan.stops.length-1)return; const t=currentPlan.stops[i]; currentPlan.stops[i]=currentPlan.stops[i+dir]; currentPlan.stops[i+dir]=t; currentPlan.segments=[]; saveState(); renderInputPage(); }
        function addStop(){ currentPlan.stops.splice(currentPlan.stops.length-1,0,{id:'s'+Date.now(), name:'', location:'', stayMinutes:30}); saveState(); renderInputPage(); }
        function removeStop(i){ currentPlan.stops.splice(i,1); currentPlan.segments.splice(i,1); saveState(); renderInputPage(); }
        function setBase(i){ currentPlan.stops.forEach(s=>s.isBaseTime=false); currentPlan.stops[i].isBaseTime=true; saveState(); renderInputPage(); }
        function changeMode(i,m){ currentPlan.segments[i].travelMode=m; saveState(); renderInputPage(); }
        function saveLoc(id){ const s=currentPlan.stops.find(s=>s.id===id); if(s.name){ savedLocations.push(s.name); saveAllPlans(); updateDatalist(); showAlert('ä¿å­˜ã—ã¾ã—ãŸ','success'); } }
        function removeSavedLocation(i) { savedLocations.splice(i, 1); saveAllPlans(); updateDatalist(); renderDashboard(); }
        function updateDatalist(){ const l=document.getElementById('saved-locations-list'); if(l) l.innerHTML=savedLocations.map(x=>`<option value="${x}">`).join(''); }
        function clearData(){ if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ')) { localStorage.removeItem('planList'); localStorage.removeItem('itineraryState'); location.reload(); } }
        function showAlert(m,t){ const c=document.getElementById('message-container'); c.innerHTML=`<div class="px-4 py-2 text-white rounded shadow ${t==='error'?'bg-red-500':'bg-indigo-600'}">${m}</div>`; setTimeout(()=>c.innerHTML='',5000); }

    </script>
</body>
</html>
